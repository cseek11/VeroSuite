---
description: "Security Essentials (Lite Version) - For Brain B (LLM Agent)"
alwaysApply: true
---

# Security Essentials (Lite Version)

**For:** Brain B (LLM Agent)  
**Full rules in:** `.cursor/enforcement/rules/03-security.mdc`

---

## ⚠️ PRE-FLIGHT CHECK (MANDATORY BEFORE ALL OPERATIONS)

**BEFORE performing ANY security-related operations, you MUST:**

1. **FIRST TOOL CALL:** Read `.cursor/enforcement/ENFORCEMENT_BLOCK.md`
2. **IF BLOCKED:** STOP immediately, display blocking message, do NOT proceed
3. **IF NOT BLOCKED:** Continue with security operations

**This check takes precedence over ALL security operations.**

---

## Critical Security Rules (Never Violate)

### 1. Multi-Tenant Isolation

**ALWAYS filter by tenant_id:**

```typescript
// ✅ CORRECT
await prisma.customer.findMany({
  where: {
    tenant_id: currentUser.tenant_id,
    // ... other filters
  }
})

// ❌ WRONG - missing tenant_id
await prisma.customer.findMany({
  where: {
    status: 'active'
  }
})
```

### 2. Row-Level Security (RLS)

Use Prisma middleware or manual guards:

```typescript
// Option 1: Middleware (preferred)
prisma.$use(async (params, next) => {
  if (params.model && params.action === 'findMany') {
    params.args.where = {
      ...params.args.where,
      tenant_id: getTenantId()
    }
  }
  return next(params)
})

// Option 2: Manual guard
async findAll() {
  const tenant_id = this.getTenantId()
  return this.prisma.customer.findMany({
    where: { tenant_id }
  })
}
```

### 3. Authentication

Verify user before operations:

```typescript
// ✅ CORRECT
@UseGuards(JwtAuthGuard, TenantGuard)
async getCustomers() {
  // Implementation
}

// ❌ WRONG - no guards
async getCustomers() {
  // Direct access
}
```

### 4. Input Validation

Always validate user input:

```typescript
// ✅ CORRECT
@Post()
async create(@Body() dto: CreateCustomerDto) {
  // DTO has class-validator decorators
}

// ❌ WRONG - no validation
async create(@Body() data: any) {
  // Dangerous
}
```

### 5. Security Logging

Log security events:

```typescript
// ✅ CORRECT
this.logger.warn({
  event: 'AUTH_FAILED',
  user_id: userId,
  ip: request.ip,
  timestamp: new Date()
})
```

---

**If you forget any of these, the enforcer will catch it.**

**But try to get them right the first time.**
