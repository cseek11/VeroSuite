---
description: "VeroForge master rule: CI integration, REWARD_SCORE, pattern extraction, and global precedence"
alwaysApply: true
---

# Cursor: Engineering Swarm ‚Äî Optimized Rules (Cursor-native, CI-driven, Modular)

## RULE PRECEDENCE
This file (`.cursor/rules/00-master.mdc`) supersedes and overrides every other rule file in `.cursor/rules/` unless another section inside this file explicitly delegates control. If any legacy directive conflicts with guidance here, Cursor must obey this file first.

## VERSION & CHANGE CONTROL
- **Version:** 2.0 (2025-12-04)  
- **Change Log:** Track updates in `docs/architecture/cursor_rules_upgrade.md#changelog`.
- **Memory Bank Integration:** Added Step 0 to enforcement pipeline, Memory Bank system integrated (2025-12-04)  
- **Emergency Override (`@emergency_override`)**: If a unified rule causes critical breakage, include `@emergency_override:<rule-id>:<expires YYYY-MM-DD>` in a PR description. Cursor must treat the flagged rule as paused until the expiration (max 7 days) or manual removal. All overrides require approval from a Rules Champion and must be logged in `docs/architecture/cursor_rules_upgrade.md`.

## NAMESPACE CONSOLIDATION
- All sections in this document form the **"VeroForge Unified Rules"** namespace.
- Existing files under `.cursor/rules_legacy/*` form the **"Legacy Ruleset."**
- When instructions conflict, apply "VeroForge Unified Rules" and treat the "Legacy Ruleset" as supplemental context only.

## PURPOSE
These rules define how Cursor should behave in this workspace for:
- PR evaluation and REWARD_SCORE integration (CI as source-of-truth).
- Role-based guidance (modular prompts) for review, testing, coaching, distillation.
- Pattern application (human-reviewed, version-controlled).
- Safety, security, and routing.
- Clear human-in-the-loop for pattern extraction and automation.

Cursor MUST follow these rules unless the user explicitly overrides them.

---

## GLOBAL PRINCIPLES (applies to all modes)
- Prefer correctness & safety over automation.
- CI is the authoritative source for computed artifacts (REWARD_SCORE, coverage, static-analysis outputs).
- Never hallucinate file paths, PR numbers, or metrics. If uncertain, state you cannot find them and list closest matches.
- Always cite real file paths when referencing code (e.g., `src/auth/token_manager.py`).
- Prefer human-in-the-loop for knowledge updates (pattern creation, distillation) until patterns reach stable quality.
- Reference repository-specific guardrails from `AI_CONSISTENCY_PROTOCOL.md`, `DEVELOPMENT_BEST_PRACTICES.md`, and security policies captured in `.cursor/rules/03-security.mdc`.

---

## FILES / FOLDERS THIS RULES FILE RELIES ON
- `.cursor/prompts/` (role prompts; modular)
- `.cursor/patterns/` (golden patterns, validated)
- `.cursor/golden_patterns.md` (index + metadata)
- `.cursor/anti_patterns.md` (logged anti-patterns)
- `.cursor/BUG_LOG.md` (manual bug log)
- `.cursor/PYTHON_LEARNINGS_LOG.md` (Python audit learnings - **MUST** reference when working with Python code)
- `.cursor/memory-bank/` (Memory Bank - context preservation across sessions)
- `.cursor/reward_rubric.yaml` (score weights & conditions)
- `.cursor/DEPRECATED_RULES.md` (migration tracker)
- `.cursor/scripts/` (`compute_reward_score.py`, `extract_patterns.py`, `suggest_patterns.py`, `reindex_embeddings.py`)
- `.cursor/ci/reward_score_comment_template.md`
- CI outputs (PR comment or artifact with REWARD_SCORE and breakdown JSON)
- `.cursor/enforcement/` (Auto-Enforcement System - status files and violation logs)
- `.cursor/scripts/auto-enforcer.py` (Main enforcement engine)
- `.cursor/scripts/watch-files.py` (File watcher for real-time enforcement)
- `.cursor/scripts/pre-flight-check.py` (Pre-flight validation script)

---

## PRE-FLIGHT CHECK (MANDATORY PREREQUISITE)

**‚ö†Ô∏è CRITICAL:** Before executing any task, Cursor MUST complete the pre-flight check.

### Pre-Flight Check Requirements

1. **Read Enforcement Block Message (MANDATORY - CHECK FIRST):**
   - **MUST** read `.cursor/enforcement/ENFORCEMENT_BLOCK.md` FIRST before any action
   - **IF FILE EXISTS:** You are BLOCKED - read entire message and STOP immediately
   - **IF FILE DOES NOT EXIST:** Continue to step 2
   - This file is automatically generated by the enforcer when violations are detected
   - It contains a blocking message that acts as an "automatic prompt" from the enforcer

2. **Read Agent Status (MANDATORY):**
   - **MUST** read `.cursor/enforcement/AGENT_STATUS.md` after checking ENFORCEMENT_BLOCK.md
   - **MUST** stop if status is üî¥ BLOCKED - fix violations before proceeding
   - **MUST** review `.cursor/enforcement/AGENT_REMINDERS.md` for active reminders
   - **MUST** check `.cursor/enforcement/VIOLATIONS.md` for recent violations

2. **Run Pre-Flight Script (RECOMMENDED):**
   - Execute `.cursor/scripts/pre-flight-check.py` to validate:
     - Memory Bank files exist and are current
     - Rule files are intact
     - Context is available for decision-making
   - Review pre-flight output before proceeding

3. **Integration with Step 0:**
   - Pre-flight check validates Memory Bank compliance (Step 0 prerequisite)
   - Pre-flight check ensures rule integrity before enforcement pipeline
   - Pre-flight check provides context summary for informed decision-making

### Pre-Flight Check Output

The pre-flight check script outputs:
- Memory Bank status (all 6 files present, staleness check)
- Rule file integrity (all rule files readable)
- Context summary (key information from Memory Bank)
- Compliance status (ready to proceed or blocked)

### Hard Stop Conditions

The following conditions trigger üî¥ BLOCKED status and prevent task execution:

1. **Hardcoded Dates** (02-core.mdc violation) - HARD STOP
2. **Missing Memory Bank Context** (01-enforcement.mdc Step 0) - HARD STOP
3. **Security Violations** (03-security.mdc) - HARD STOP
4. **Missing activeContext.md Update** (01-enforcement.mdc Step 5) - HARD STOP
5. **Silent Failures** (06-error-resilience.mdc) - HARD STOP
6. **Missing Bug Logging** (01-enforcement.mdc Step 4.5) - HARD STOP

**If any hard stop condition is detected, Cursor MUST:**
- Display the violation clearly
- Provide remediation guidance
- Refuse to proceed until violation is resolved

---

## ROUTING & MODE SELECTION (TRIAGER)
Cursor should load multiple modes additively depending on context:
1. Inspect file paths / PR description / tags.
2. Always include:
   - general patterns (`.cursor/patterns/*`)
   - security rules (`.cursor/prompts/security_review.md`)
   - testing rules (`.cursor/prompts/tester.md`) if code changed
3. Add specialized modes:
   - Backend: `backend/`, `src/api/`, `src/services/`, `*.ts`, `*.py`, `*.go` ‚Üí `backend_reviewer.md`
   - Frontend: `frontend/`, `src/components/`, `*.tsx`, `*.jsx` ‚Üí `frontend_reviewer.md`
   - Infra: `infra/`, `deploy/`, `k8s/`, `*.tf`, `.github/workflows/` ‚Üí `infra_reviewer.md`
   - Data: `pipelines/`, `*.sql`, `airflow/`, analytics folders ‚Üí `distill_data.md`
4. If multiple areas match, load all relevant prompts (routing is additive, not exclusive).
5. If no path matches, default to `@lead` prompt (`.cursor/prompts/lead_review.md`).

### CONDITIONAL BIBLE RULE LOADING

**Bible rules are language-specific and should only be actively applied when working with matching file types:**

- **Python Bible** (`python_bible.mdc`):
  - **Apply when:** Working with `**/*.py`, `**/*.pyi`, `**/requirements*.txt`, `**/setup.py`, `**/pyproject.toml`, `**/Pipfile`, `**/poetry.lock`, `.cursor/scripts/*.py`
  - **Do NOT apply for:** TypeScript, JavaScript, or other languages
  - **Metadata:** `alwaysApply: false`, `applyWhen: ["**/*.py", ...]`
  
- **TypeScript Bible** (`typescript_bible.mdc`):
  - **Apply when:** Working with `**/*.ts`, `**/*.tsx`, `**/tsconfig.json`, `**/tsconfig.*.json`
  - **Do NOT apply for:** Python, JavaScript, or other languages
  - **Metadata:** `alwaysApply: false`, `applyWhen: ["**/*.ts", ...]`

**Detection Logic:**
1. Check file paths in current context (open files, changed files, PR files)
2. If ANY file matches Bible rule patterns ‚Üí actively apply that Bible rule
3. If NO files match ‚Üí skip Bible rule application (rules still loaded but not actively enforced)
4. Default: Apply both if uncertain (safety fallback for mixed-language contexts)

**Note:** Cursor automatically loads all `.mdc` files, but the AI agent should only actively enforce Bible rules when working with matching file types to reduce context size and improve performance.

---

## MODULAR PROMPTS (HOW TO USE)
Cursor delegates behaviour to prompt files inside `.cursor/prompts/`. `00-master.mdc` orchestrates and loads prompts; prompts are authoritative for each role and must define:
- Required output format (machine-parseable first, human-friendly second).
- Fail-safe lines like: `If data missing, say "MISSING: <what>"`.
- Explicit citation requirements.

Required prompt files:
- `.cursor/prompts/lead_review.md`
- `.cursor/prompts/tester.md`
- `.cursor/prompts/coach.md`
- `.cursor/prompts/backend_reviewer.md`
- `.cursor/prompts/frontend_reviewer.md`
- `.cursor/prompts/infra_reviewer.md`
- `.cursor/prompts/security_review.md`

---

## @LEAD ‚Äî PR REVIEW MODE (CI-ASSISTED)
**Trigger:** `cursor chat "review PR #<n>"` or CI comment.

**Workflow:**
1. Read CI-supplied REWARD_SCORE comment/artifact if present.
2. If no CI score, ask for CI outputs or compute a *draft* score using local analysis and label it `DRAFT`.
3. Required output (machine-friendly + human readable):

```
REWARD_SCORE: X/10 (source: CI | DRAFT)
Breakdown:
tests: +3
bug_fix: +2
docs: +1
penalties: -2

Assessment:
<2‚Äì4 sentences>

Actionable Feedback:
- ...
- ...

Decision:
APPROVE / REQUEST_CHANGES / BLOCK
```

**Rules:**
- If CI score < -3 and CI indicates failing tests/security issues ‚Üí BLOCK and request changes.
- If REWARD_SCORE is borderline (-3..3) ‚Üí require explicit `@lead` human review tag for merge.
- Always document references to CI artifacts or attach `reward_score_comment_template.md`.

---

## @TESTER ‚Äî TEST GENERATION MODE
**Trigger:** Code changes in non-test files or explicit request.

**Deliverables per change set:**
- 3‚Äì6 unit tests covering happy path, edge cases, and error cases.
- Mocks/fixtures when external services involved.
- Coverage delta report (approximate) and files to add.
- Test suggestions must point to exact file paths & test file template (e.g., `backend/tests/test_auth_token.ts`).

---

## @COACH ‚Äî PATTERN EXTRACTION (HUMAN-IN-THE-LOOP)
**Trigger:** High-score PR (CI REWARD_SCORE ‚â• 6) or manual invocation.

Template:
```
Pattern: [Short name]
WHEN: [When to apply]
DO: [Implementation guidance]
WHY: [Principle]
EXAMPLE: path/to/file.ts#Lxx
METADATA: domain=[backend|frontend|infra|data], complexity=[simple|medium|complex], source_pr=#123
```

**Human step:** A senior engineer reviews candidate pattern before it's committed to `.cursor/patterns/`.

**Automation note:** CI may run `scripts/extract_patterns.py` to suggest patterns, but commits must be human-approved.

---

## DISTILLATION AGENTS (IN-PROMPT)
Cursor uses distilled knowledge from:
- `.cursor/patterns/` (primary)
- `.cursor/golden_patterns.md` (index)
- `.cursor/anti_patterns.md` (failures)
- `.cursor/BUG_LOG.md`
- `.cursor/PYTHON_LEARNINGS_LOG.md` (Python-specific learnings - **MUST** reference when working with Python code)
- `.cursor/memory-bank/` (Memory Bank - project context and continuity)

Distillation is prompt-driven (no model fine-tuning). Additions to these files immediately change agent outputs.

---

## PATTERN MANAGEMENT RULES
- Patterns are authoritative only after a human reviewer merges the pattern file via PR.
- Pattern file naming: `NNN_domain_short-name.md` (e.g., `001_backend_circuit_breaker.md`).
- Each pattern must include metadata (`created_at`, `author`, `source_pr`, `domain`, `complexity`).
- Maintain `.cursor/golden_patterns.md` as the canonical index.
- Anti-patterns for low-scoring PRs go into `.cursor/anti_patterns.md` plus `.cursor/BUG_LOG.md`.

---

## DOCUMENTATION FILE PURPOSES

### Error Pattern Documentation (`docs/error-patterns.md`)
- **Purpose:** Detailed knowledge base for learning and prevention
- **When:** Document every bug fix with full analysis
- **Content:** Root cause, triggers, fixes, prevention strategies, code examples
- **Audience:** Developers learning from past mistakes

### Bug Log (`.cursor/BUG_LOG.md`)
- **Purpose:** Concise tracking log for compliance and history
- **When:** Log every bug fix (mandatory)
- **Content:** Date, area, description, status, owner, notes, link to error-patterns.md
- **Audience:** Compliance tracking, quick reference, historical record

### Anti-Patterns Log (`.cursor/anti_patterns.md`)
- **Purpose:** Known bad patterns to avoid
- **When:** Log anti-patterns from low-score PRs (REWARD_SCORE ‚â§ 0)
- **Content:** Date, PR, description, impact, follow-up, prevention pattern
- **Audience:** AI agents and developers to prevent regressions

### Python Learnings Log (`.cursor/PYTHON_LEARNINGS_LOG.md`)
- **Purpose:** Learnings from Python code audits and Python Bible compliance reviews
- **When:** **MUST** reference when working with Python code (`*.py` files, Python audits, Python Bible compliance). Log significant learnings during Python audits (mistakes, best practices, evidence-backed insights)
- **Content:** Key learnings, mistakes made, Python Bible references, actionable guidance, evidence
- **Audience:** AI agents conducting Python audits, developers learning from audit process

### Relationship
- Bug fixes require BOTH error-patterns.md (detailed) AND BUG_LOG.md (concise)
- Anti-patterns from low-score PRs go in anti_patterns.md AND BUG_LOG.md
- All entries should cross-reference each other

---

## BUG FIX DOCUMENTATION REQUIREMENTS

**MANDATORY:** When fixing a bug, you MUST:

1. **Document the error pattern** in `docs/error-patterns.md`:
   - Detailed root cause analysis
   - Triggering conditions
   - Fix implementation
   - Prevention strategies
   - Code examples

2. **Log the bug** in `.cursor/BUG_LOG.md`:
   - Concise entry with date, area, description, status, owner, notes
   - Link to error-patterns.md entry
   - Track bug history and compliance

3. **Cross-reference both files:**
   - BUG_LOG.md entry must link to error-patterns.md (e.g., `Related: docs/error-patterns.md#BUG_NAME`)
   - error-patterns.md entry should reference BUG_LOG.md date

**Enforcement:**
- Step 5 (Post-Implementation Audit) MUST verify both entries exist
- Missing entries = compliance violation (HARD STOP)

---

## ANTI-PATTERN & BUG LOGGING

### Bug Fixes (ALL Bugs)
- **MANDATORY:** When fixing ANY bug, you MUST:
  1. Log entry in `.cursor/BUG_LOG.md` (concise tracking)
  2. Document pattern in `docs/error-patterns.md` (detailed learning)
  3. Cross-reference both files

### Low-Score PRs (REWARD_SCORE ‚â§ 0)
- **MANDATORY:** When PR has REWARD_SCORE ‚â§ 0, you MUST:
  1. Log anti-pattern in `.cursor/anti_patterns.md`
  2. Log associated bug in `.cursor/BUG_LOG.md` (if bug was fixed)
  3. Document error pattern in `docs/error-patterns.md` when:
     - Bug occurred in production OR affected multiple users
     - Bug fix addresses a recurring pattern (‚â•2 occurrences)
     - Root cause is non-obvious or required >1 hour to diagnose
     - Prevention strategy can help future development
     - **ALWAYS document:** Security bugs, data corruption, financial calculation errors, production incidents
     - **NOT applicable for:** Typos, simple logic errors with obvious fixes, one-off edge cases
     - **Decision aid:** If someone else could make the same mistake, document it

### Entry Requirements
- Every entry includes: detection context, remediation guidance, and follow-up owner
- BUG_LOG.md entries must link to error-patterns.md
- Anti-pattern entries must reference source PR/issue

---

## SECURITY RULES (NON-NEGOTIABLE)
Cursor must refuse to produce code that:
- Exposes PII or secrets.
- Stores credentials in source code.
- Demonstrates insecure cryptography or SQL concatenation.
- Suggests disabling authentication or auditing.

For requests needing bypasses, respond with a refusal and outline safe alternatives. Cross-reference `.cursor/rules/03-security.mdc` for domain-specific requirements; unified rules override on conflicts.

---

## CONTEXT RETRIEVAL & FALLBACKS
When the user asks for internal knowledge:
1. **First:** Load Memory Bank context from `.cursor/memory-bank/` (Step 0 of enforcement pipeline).
2. Attempt semantic search across source code, `.cursor/patterns/`, `.cursor/prompts/`.
3. If semantic search omits `.cursor/patterns/*`, explicitly load relevant pattern files (fallback).
4. If a referenced file/artifact is not found, return `MISSING: <file>` and provide nearest matches.

## MEMORY BANK SYSTEM
The Memory Bank (`.cursor/memory-bank/`) preserves project context across AI sessions. Since AI memory resets between sessions, the Memory Bank serves as the single source of truth for understanding the project.

### Memory Bank Files
- `projectbrief.md` - Foundation: project goals, scope, requirements
- `productContext.md` - Why: problems solved, user experience goals
- `systemPatterns.md` - How: architecture, patterns, technical decisions
- `techContext.md` - What: technologies, setup, constraints
- `activeContext.md` - Now: current work, recent changes, next steps
- `progress.md` - Status: what works, what's left, known issues

### Integration with Enforcement Pipeline
- **Step 0:** Memory Bank loading (read all files, update activeContext.md)
- **Step 5:** Automatic updates (update activeContext.md and progress.md after audit)

### Key Principles
- **Memory Bank = Context & Continuity** (what, why, where)
- **VeroField Rules = Enforcement & Quality** (how, standards, gates)
- Memory Bank **references** existing documentation, does **not duplicate** it
- Single source of truth maintained

### Update Triggers
- **Automatic:** After Step 5 completion, major feature completion, architectural changes
- **On-Demand:** User requests "update memory bank", context refresh needed

See `.cursor/memory-bank/README.md` for complete Memory Bank documentation.

---

## CI INTEGRATION (SOURCE OF TRUTH)
- CI steps must compute and publish:
  - `REWARD_SCORE` (with breakdown JSON or PR comment).
  - Test coverage summary (JSON).
  - Static analysis results (JSON).
- Cursor reads PR comments or artifacts with the key `SWARM_SCORE_JSON` or the standard reward template.
- Required workflows live in `.github/workflows/` and may call scripts in `.cursor/scripts/`.
- Any manual computation must be labeled `DRAFT`.

### Workflow Trigger Requirements
- **MANDATORY:** All workflows must have `on:` section with appropriate triggers.
- **MANDATORY:** PR workflows must include: `types: [opened, synchronize, reopened]`.
- **MANDATORY:** `workflow_run` triggers must match exact workflow names (case-sensitive).
- **MANDATORY:** Workflow names in `workflow_run` must exist in `.github/workflows/`.
- **MANDATORY:** Artifact names must be consistent across workflows (standard names: `reward`, `frontend-coverage`, `backend-coverage`).
- **MANDATORY:** Cascading workflows must verify parent workflow completed successfully.
- **MANDATORY:** Conditional logic (score thresholds) must be implemented for pattern extraction and anti-pattern detection.

---

## METRICS & OBSERVABILITY
Cursor expects:
- REWARD_SCORE distribution dashboards.
- Agent human-edit rate metrics.
- Pattern adoption counts.
- Anti-pattern recurrence reports.

If data is missing, surface `MISSING: <metric>` in outputs.

---

## HUMAN OVERRIDES & ESCALATION
- `@lead` humans may override CI-computed REWARD_SCORE (CID stored in DB/PR comment).
- Changes to `.cursor/patterns/` must be through PR reviewed by a Swarm Champion.
- Security/infra code requires explicit human approval before merge (document in PR).
- Any override or emergency suspension must be logged in `docs/architecture/cursor_rules_upgrade.md`.

---

## VERSIONING, ROLLBACK & REQUIRED APPROVALS
- Patterns and rules live in git; rollback = `git revert`.
- Automated scripts modifying `.cursor/*` must create a PR for human review.
- PRs touching `00-master.mdc` or any file in `.cursor/rules/*` require approval from the designated Rules Champion list in `docs/architecture/cursor_rules_upgrade.md`.

---

## SAFEGUARDS & VALIDATION
- CI validates required files exist (prompts, patterns, scripts). Failing checks block merges.
- Conflict-detection automation scans legacy files for overlapping directives and opens issues/PR comments.
- Testing harness (documented in `docs/architecture/cursor_rules_upgrade.md`) must be run after major rule changes to verify routing and precedence behavior.
- `DEPRECATED_RULES.md` tracks reconciliation progress for each legacy document.

---

## LEGACY RULE COMPATIBILITY
Cursor must continue to load the existing `.cursor/rules_legacy/*` documents. However, if a legacy file conflicts with instructions in this `00-master.mdc`:
- Treat the legacy file as legacy guidance.
- Follow the newer rule defined here (VeroForge Unified Rules).
Document reconciled files in `.cursor/DEPRECATED_RULES.md` and update CI conflict flags.

---

## CONTEXT-SENSITIVE PROMPTING

### Rule Activation Confirmation Format

When a rule is activated (based on file paths, PR tags, or explicit request), Cursor MUST:

1. **Confirm Rule Activation:**
   ```
   ‚úì Rule Activated: [Rule Name] ([Rule File])
   - Triggered by: [file path / PR tag / explicit request]
   - Applicable sections: [list section numbers]
   ```

2. **Reference Inline Rule Sections:**
   - When citing rules, use format: `[Rule File]#[Section Number]` (e.g., `03-security.mdc#R01`)
   - Include section context in responses
   - Link to specific rule sections when explaining compliance

3. **Python-Specific Reminders:**
   - When working with `.py` files, MUST reference: `.cursor/rules/python_bible.mdc`
   - When working with Python code, MUST check: `.cursor/PYTHON_LEARNINGS_LOG.md`
   - When generating Python code, MUST follow: `docs/reference/Programming Bibles/bibles/python_bible/dist/python_bible/Agent.md`

### Example Rule Activation Output

```
‚úì Rule Activated: Security Rules (03-security.mdc)
- Triggered by: apps/api/src/auth/auth.service.ts
- Applicable sections: R01 (Tenant Isolation), R02 (RLS Enforcement), R12 (Security Event Logging)

‚úì Rule Activated: Python Bible Compliance (python_bible.mdc)
- Triggered by: .cursor/scripts/auto-enforcer.py
- Applicable sections: All Python-specific patterns and anti-patterns
- Reference: docs/reference/Programming Bibles/bibles/python_bible/dist/python_bible/Agent.md
```

### Inline Rule References

When explaining compliance or violations, use inline references:

- ‚úÖ **Correct:** "Tenant isolation check passed (03-security.mdc#R01)"
- ‚úÖ **Correct:** "Hardcoded date detected (02-core.mdc#Date Handling)"
- ‚ùå **Incorrect:** "Security rule violation" (too vague)

---

## END OF RULES
