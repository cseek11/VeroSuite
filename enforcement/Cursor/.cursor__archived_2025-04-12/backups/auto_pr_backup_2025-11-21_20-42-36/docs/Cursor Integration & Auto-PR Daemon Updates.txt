#!/usr/bin/env python3
"""
Cursor Integration for Auto-PR Session Management
Patches into auto_pr_daemon.py to add session tracking metadata.
"""

# ============================================================================
# FILE 1: .cursor/scripts/cursor_session_hook.py
# Hook for Cursor to add session metadata to commits
# ============================================================================

import os
import json
import hashlib
from datetime import datetime
from pathlib import Path

SESSION_MARKER_FILE = Path(".cursor/.session_id")


def get_or_create_session_id(author: str = None) -> str:
    """
    Get existing session ID or create new one.
    
    Session ID persists until explicitly cleared or timeout.
    """
    if SESSION_MARKER_FILE.exists():
        with open(SESSION_MARKER_FILE, 'r') as f:
            data = json.load(f)
            
            # Check if session is still valid (< 30 minutes old)
            last_updated = datetime.fromisoformat(data["last_updated"])
            now = datetime.now()
            
            if (now - last_updated).total_seconds() < 1800:  # 30 minutes
                # Update timestamp and return existing ID
                data["last_updated"] = now.isoformat()
                with open(SESSION_MARKER_FILE, 'w') as f:
                    json.dump(data, f)
                return data["session_id"]
    
    # Create new session ID
    if author is None:
        author = os.environ.get("GIT_AUTHOR_NAME", "unknown")
    
    timestamp = datetime.now().strftime("%Y%m%d-%H%M")
    session_id = f"{author}-{timestamp}"
    
    data = {
        "session_id": session_id,
        "author": author,
        "created": datetime.now().isoformat(),
        "last_updated": datetime.now().isoformat()
    }
    
    SESSION_MARKER_FILE.parent.mkdir(parents=True, exist_ok=True)
    with open(SESSION_MARKER_FILE, 'w') as f:
        json.dump(data, f)
    
    return session_id


def clear_session():
    """Clear session marker (call this when manually completing)."""
    if SESSION_MARKER_FILE.exists():
        SESSION_MARKER_FILE.unlink()


def format_session_metadata(session_id: str, pr_title: str) -> tuple[str, str]:
    """
    Format PR title and body with session metadata.
    
    Returns:
        (updated_title, session_metadata_block)
    """
    # Add emoji prefix if not present
    if not pr_title.startswith("ü§ñ") and not pr_title.startswith("auto-pr:"):
        pr_title = f"ü§ñ {pr_title}"
    
    metadata_block = f"""

---
[cursor-session: {session_id}]
<!-- Auto-PR Session Tracking -->
<!-- To complete this session: add [ready] to title or comment /complete-session -->
"""
    
    return pr_title, metadata_block


# ============================================================================
# FILE 2: .cursor/scripts/auto_pr_daemon.py (MODIFIED SECTIONS)
# Modifications to auto_pr_daemon.py to integrate session tracking
# ============================================================================

# ADD THIS IMPORT AT TOP OF FILE:
from cursor_session_hook import (
    get_or_create_session_id, 
    format_session_metadata,
    clear_session
)

# MODIFY create_pull_request() FUNCTION:
def create_pull_request_with_session(
    repo,
    title: str,
    body: str,
    head_branch: str,
    base_branch: str = "main",
    author: str = None
):
    """
    Modified create_pull_request that adds session metadata.
    
    This replaces the existing create_pull_request function.
    """
    # Get or create session ID
    session_id = get_or_create_session_id(author)
    
    # Format title and body with session metadata
    updated_title, metadata_block = format_session_metadata(session_id, title)
    updated_body = body + metadata_block
    
    print(f"üì¶ Creating PR in session: {session_id}")
    print(f"   Title: {updated_title}")
    
    # Create PR with updated metadata
    pr = repo.create_pull(
        title=updated_title,
        body=updated_body,
        head=head_branch,
        base=base_branch
    )
    
    # Add label for easy filtering
    try:
        pr.add_to_labels("auto-pr")
    except Exception as e:
        print(f"‚ö†Ô∏è  Could not add label: {e}")
    
    return pr


# MODIFY main() function to add completion check:
def main():
    """Main auto-PR daemon loop with session management."""
    
    # ... existing code ...
    
    # Check if this is a completion marker
    if should_complete_session(commit_message):
        print("‚úÖ Completion marker detected - clearing session")
        clear_session()
    
    # Create PR with session tracking
    pr = create_pull_request_with_session(
        repo,
        title=pr_title,
        body=pr_body,
        head_branch=branch_name,
        base_branch=base_branch,
        author=author
    )
    
    # ... rest of existing code ...


def should_complete_session(message: str) -> bool:
    """Check if commit message indicates session completion."""
    completion_markers = [
        "[ready]",
        "[session-complete]",
        "ready for review",
        "‚úÖ",
        "complete"
    ]
    
    message_lower = message.lower()
    return any(marker in message_lower for marker in completion_markers)


# ============================================================================
# FILE 3: .cursor/scripts/session_cli.py
# CLI tool for managing sessions from cursor
# ============================================================================

import argparse
import subprocess
from cursor_session_hook import get_or_create_session_id, clear_session


def cmd_start():
    """Start a new session."""
    clear_session()  # Clear any existing session
    session_id = get_or_create_session_id()
    print(f"‚úÖ Started new session: {session_id}")
    print(f"   All commits will be tracked under this session.")
    print(f"   Use 'session complete' when done.")


def cmd_status():
    """Show current session status."""
    try:
        session_id = get_or_create_session_id()
        print(f"üì¶ Active session: {session_id}")
        
        # Get session details from manager
        result = subprocess.run(
            ["python", ".cursor/scripts/auto_pr_session_manager.py", "status", "--session-id", session_id],
            capture_output=True,
            text=True
        )
        
        if result.returncode == 0:
            print("\nSession details:")
            print(result.stdout)
    except Exception as e:
        print(f"‚ùå Error: {e}")


def cmd_complete():
    """Complete current session."""
    try:
        session_id = get_or_create_session_id()
        
        # Trigger completion
        result = subprocess.run(
            ["python", ".cursor/scripts/auto_pr_session_manager.py", "complete", "--session-id", session_id],
            capture_output=True,
            text=True
        )
        
        if result.returncode == 0:
            clear_session()
            print(f"‚úÖ Session {session_id} completed")
            print(result.stdout)
        else:
            print(f"‚ùå Error completing session: {result.stderr}")
    except Exception as e:
        print(f"‚ùå Error: {e}")


def cmd_clear():
    """Clear session without completing (start fresh)."""
    clear_session()
    print("‚úÖ Session cleared - next commit will start a new session")


def main():
    parser = argparse.ArgumentParser(
        description="Cursor Session Manager CLI",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # Start a new session
  python session_cli.py start
  
  # Check session status
  python session_cli.py status
  
  # Complete current session
  python session_cli.py complete
  
  # Clear session (without completing)
  python session_cli.py clear
        """
    )
    
    subparsers = parser.add_subparsers(dest='command', help='Commands')
    
    subparsers.add_parser('start', help='Start new session')
    subparsers.add_parser('status', help='Show session status')
    subparsers.add_parser('complete', help='Complete current session')
    subparsers.add_parser('clear', help='Clear session without completing')
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    commands = {
        'start': cmd_start,
        'status': cmd_status,
        'complete': cmd_complete,
        'clear': cmd_clear
    }
    
    commands[args.command]()


if __name__ == "__main__":
    main()


# ============================================================================
# FILE 4: .cursor/commands/session.json
# Cursor command definitions for session management
# ============================================================================

# Add this to your cursor commands configuration
"""
{
  "commands": [
    {
      "name": "session:start",
      "description": "Start a new auto-PR session",
      "command": "python .cursor/scripts/session_cli.py start",
      "shortcut": "cmd+shift+s"
    },
    {
      "name": "session:status",
      "description": "Show current session status",
      "command": "python .cursor/scripts/session_cli.py status",
      "shortcut": "cmd+shift+i"
    },
    {
      "name": "session:complete",
      "description": "Complete current session and trigger scoring",
      "command": "python .cursor/scripts/session_cli.py complete",
      "shortcut": "cmd+shift+c"
    }
  ]
}
"""


# ============================================================================
# FILE 5: setup_session_management.sh
# Setup script to install session management system
# ============================================================================

#!/bin/bash
"""
Setup Session Management System

Run this script to install and configure the auto-PR session system.

Usage:
    bash .cursor/scripts/setup_session_management.sh
"""

set -e

echo "üöÄ Setting up Auto-PR Session Management System..."

# Create directory structure
echo "üìÅ Creating directories..."
mkdir -p .cursor/scripts
mkdir -p .cursor/config
mkdir -p .cursor/data
mkdir -p docs/metrics
mkdir -p docs/metrics/analytics

# Create default config if not exists
if [ ! -f .cursor/config/session_config.yaml ]; then
    echo "‚öôÔ∏è  Creating default configuration..."
    cat > .cursor/config/session_config.yaml << 'EOF'
timeout_minutes: 30
idle_warning_minutes: 15
auto_pr_patterns:
  - "^auto-pr:"
  - "^wip:"
  - "^\\[auto\\]"
  - "^checkpoint:"
  - "^cursor-session"
  - "^ü§ñ"
completion_markers:
  - "ready for review"
  - "complete"
  - "[session-complete]"
  - "[ready]"
  - "‚úÖ"
min_files_for_manual: 5
enable_timeout_completion: true
enable_heuristic_completion: true
EOF
fi

# Initialize session data file if not exists
if [ ! -f docs/metrics/auto_pr_sessions.json ]; then
    echo "üìä Initializing session data..."
    cat > docs/metrics/auto_pr_sessions.json << 'EOF'
{
  "version": "1.0",
  "last_updated": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "active_sessions": {},
  "completed_sessions": []
}
EOF
fi

# Install Python dependencies
echo "üì¶ Installing Python dependencies..."
pip install pyyaml 2>/dev/null || echo "‚ö†Ô∏è  Could not install pyyaml (may already be installed)"

# Make scripts executable
echo "üîß Making scripts executable..."
chmod +x .cursor/scripts/auto_pr_session_manager.py
chmod +x .cursor/scripts/session_cli.py
chmod +x .cursor/scripts/cursor_session_hook.py
chmod +x .cursor/scripts/session_analytics.py

# Test installation
echo "üß™ Testing installation..."
python .cursor/scripts/auto_pr_session_manager.py status > /dev/null 2>&1 && \
    echo "‚úÖ Session manager working" || \
    echo "‚ùå Session manager test failed"

python .cursor/scripts/session_cli.py --help > /dev/null 2>&1 && \
    echo "‚úÖ CLI tool working" || \
    echo "‚ùå CLI tool test failed"

echo ""
echo "‚úÖ Setup complete!"
echo ""
echo "üìñ Quick Start:"
echo "   1. Start a session:  python .cursor/scripts/session_cli.py start"
echo "   2. Make commits (they'll be tracked automatically)"
echo "   3. Complete session: python .cursor/scripts/session_cli.py complete"
echo ""
echo "üîç Check status:      python .cursor/scripts/session_cli.py status"
echo "üìä View analytics:    python .cursor/scripts/session_analytics.py"
echo ""
echo "For GitHub Actions integration, ensure workflows are committed to .github/workflows/"


# ============================================================================
# FILE 6: README_SESSION_MANAGEMENT.md
# Documentation for session management system
# ============================================================================

"""
# Auto-PR Session Management System

## Overview

The Auto-PR Session Management System intelligently batches micro-commits from cursor into logical "sessions" that are scored as a single unit, preventing reward score pollution from work-in-progress commits.

## Key Features

- **Automatic Detection**: Identifies auto-PR micro-commits based on title patterns
- **Session Batching**: Groups related PRs into sessions
- **Smart Completion**: Multiple triggers for session completion
- **Analytics Dashboard**: Visual tracking of session metrics
- **GitHub Integration**: Seamless workflow integration

## How It Works

### 1. Session Creation

When you make a commit with an auto-PR pattern (e.g., "auto-pr: add tests"), the system:
- Detects this is a micro-commit
- Creates or adds to an active session
- Adds session metadata to the PR
- Skips reward score computation

### 2. Session Tracking

Sessions track:
- All PRs in the session
- Files changed
- Tests added
- Documentation updates
- Duration

### 3. Session Completion

Sessions complete when:
- **Explicit marker**: Add `[ready]` or `ready for review` to PR title/body
- **Manual trigger**: Comment `/complete-session` on PR
- **Timeout**: 30 minutes of inactivity (configurable)
- **Heuristic**: Tests added + docs updated
- **Manual CLI**: Run `session complete` command

### 4. Scoring

When completed:
- All PRs in session aggregated
- Single reward score computed for entire session
- Session metadata included in score

## CLI Usage

### Start New Session
```bash
python .cursor/scripts/session_cli.py start
```

### Check Status
```bash
python .cursor/scripts/session_cli.py status
```

### Complete Session
```bash
python .cursor/scripts/session_cli.py complete
```

### View Analytics
```bash
python .cursor/scripts/session_analytics.py
```

## GitHub Actions

### Manual Completion
Comment on any PR: `/complete-session`

### Automatic Cleanup
Orphaned sessions are cleaned up daily at 2 AM UTC

## Configuration

Edit `.cursor/config/session_config.yaml`:

```yaml
timeout_minutes: 30              # Session timeout
idle_warning_minutes: 15         # Warn after this idle time
enable_timeout_completion: true  # Auto-complete on timeout
enable_heuristic_completion: true # Complete on tests+docs
```

## Auto-PR Patterns

PRs are detected as auto-PRs if title/commit matches:
- `auto-pr:`
- `wip:`
- `[auto]`
- `checkpoint:`
- `ü§ñ` (robot emoji)

## Completion Markers

Add these to title/body to trigger completion:
- `ready for review`
- `[ready]`
- `[session-complete]`
- `complete`
- `‚úÖ` (checkmark emoji)

## Analytics

View session analytics:
- Author performance
- Completion trigger distribution
- Duration distribution
- PRs per session

Access via web dashboard or CLI.

## Troubleshooting

### Session not completing
- Check session status: `session status`
- Manually complete: `session complete`
- Check timeout settings in config

### PRs not being batched
- Verify PR title has auto-PR pattern
- Check session metadata in PR body
- Review `.cursor/config/session_config.yaml`

### Orphaned sessions
- Run cleanup: `python .cursor/scripts/auto_pr_session_manager.py cleanup`
- Check `docs/metrics/auto_pr_sessions.json`

## Integration with Existing System

The session system integrates with:
- `compute_reward_score.py` - Handles batched scoring
- `auto_pr_daemon.py` - Adds session metadata
- GitHub Actions - Workflow orchestration

No breaking changes to existing workflows.
"""

if __name__ == "__main__":
    print(__doc__)