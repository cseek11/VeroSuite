name: Session Health Check

on:
  schedule:
    # Run daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  health-check:
    name: Session Health Monitoring
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pyyaml
      
      - name: Run Health Check
        id: health
        run: |
          python .cursor/scripts/monitor_sessions.py --json > health_report.json
          cat health_report.json
          
          STATUS=$(jq -r '.status' health_report.json)
          echo "status=$STATUS" >> "$GITHUB_OUTPUT"
          
          ALERTS_COUNT=$(jq -r '.alerts | length' health_report.json)
          echo "alerts_count=$ALERTS_COUNT" >> "$GITHUB_OUTPUT"
      
      - name: Create Issue for Critical Alerts
        if: steps.health.outputs.status != 'healthy' && steps.health.outputs.alerts_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('health_report.json', 'utf8'));
            
            const title = `âš ï¸ Session Health Alert - ${new Date().toISOString().split('T')[0]}`;
            const body = `## Session Health Report
            
**Status:** ${report.status.toUpperCase()}
**Timestamp:** ${report.timestamp}

### Metrics
${Object.entries(report.metrics || {}).map(([k, v]) => `- ${k}: ${v}`).join('\n')}

### Alerts
${report.alerts.map(a => `- âš ï¸ ${a}`).join('\n')}

${report.orphaned_session_ids && report.orphaned_session_ids.length > 0 ? `
### Orphaned Sessions (first 10)
${report.orphaned_session_ids.map(id => `- ${id}`).join('\n')}
` : ''}

---
*This is an automated health check. Please review and take action if needed.*`;
            
            // Check if issue already exists today
            const today = new Date().toISOString().split('T')[0];
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'session-health'
            });
            
            const todayIssue = issues.find(issue => issue.title.includes(today));
            
            if (todayIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: todayIssue.number,
                body: body
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['session-health', 'automated']
              });
            }
      
      - name: Create Summary
        run: |
          STATUS=$(jq -r '.status' health_report.json)
          ALERTS=$(jq -r '.alerts | length' health_report.json)
          
          echo "### ðŸ¥ Session Health Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** $STATUS" >> $GITHUB_STEP_SUMMARY
          echo "**Alerts:** $ALERTS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$ALERTS" -gt 0 ]; then
            echo "### âš ï¸ Alerts" >> $GITHUB_STEP_SUMMARY
            jq -r '.alerts[]' health_report.json | while read alert; do
              echo "- $alert" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "âœ… No alerts - system healthy" >> $GITHUB_STEP_SUMMARY
          fi








