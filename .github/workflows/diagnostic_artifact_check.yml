name: Diagnostic - Artifact Check

on:
  workflow_run:
    workflows: ["Swarm - Compute Reward Score"]
    types: [completed]

jobs:
  check-artifacts:
    runs-on: ubuntu-latest
    steps:
      - name: Check workflow conclusion
        run: |
          echo "Workflow: ${{ github.event.workflow_run.name }}"
          echo "Conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "Run ID: ${{ github.event.workflow_run.id }}"
          echo "Head Branch: ${{ github.event.workflow_run.head_branch }}"
      
      - name: List all artifacts
        run: |
          gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts" \
            | jq '{
                total_count: .total_count,
                artifacts: [.artifacts[] | {
                  name: .name,
                  size: .size_in_bytes,
                  expired: .expired,
                  created_at: .created_at
                }]
              }'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Check for reward artifact
        run: |
          ARTIFACTS=$(gh api \
            "/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts" \
            | jq -r '.artifacts[] | select(.name | startswith("reward-pr-")) | .name')
          
          if [ -z "$ARTIFACTS" ]; then
            echo "❌ NO REWARD ARTIFACTS FOUND"
            echo "This indicates compute_reward_score.py failed to create reward.json"
            echo "Workflow conclusion: ${{ github.event.workflow_run.conclusion }}"
            exit 1
          else
            echo "✓ Found reward artifacts:"
            echo "$ARTIFACTS"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

