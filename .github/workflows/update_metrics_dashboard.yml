name: Update Metrics Dashboard

on:
  workflow_run:
    workflows: ["Swarm - Compute Reward Score"]
    types: [completed]
  schedule:
    # Run every 6 hours to collect any missed artifacts
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read
  actions: read

jobs:
  update-metrics:
    runs-on: ubuntu-latest
    # Only run if triggered by workflow_run and parent workflow succeeded, or if manually triggered
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Get recent successful REWARD_SCORE run IDs
        id: get-run-ids
        if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get all recent successful runs that actually completed (not skipped)
          # Filter by conclusion == "success" and status == "completed", limit to last 20
          echo "Fetching successful REWARD_SCORE runs..."
          RUN_IDS=$(gh run list --workflow="swarm_compute_reward_score.yml" --limit 50 --json databaseId,conclusion,status,createdAt --jq '[.[] | select(.conclusion == "success" and .status == "completed")] | .[0:20] | .[].databaseId' | tr '\n' ',' | sed 's/,$//')
          echo "Query result: $RUN_IDS"
          if [ -z "$RUN_IDS" ] || [ "$RUN_IDS" == "null" ]; then
            echo "No successful REWARD_SCORE runs found"
            # Use the workflow_run ID if available, otherwise exit
            if [ -n "${{ github.event.workflow_run.id }}" ]; then
              echo "run_ids=${{ github.event.workflow_run.id }}" >> "$GITHUB_OUTPUT"
            else
              exit 1
            fi
          else
            echo "run_ids=$RUN_IDS" >> "$GITHUB_OUTPUT"
            echo "Found run IDs: $RUN_IDS"
          fi

      - name: Wait for artifacts to finalize
        if: github.event_name == 'workflow_run' || github.event_name == 'workflow_dispatch'
        run: sleep 10  # Give GitHub 10 seconds to finalize artifacts (not needed for schedule)

      - name: Download reward artifacts from workflow_run
        if: github.event_name == 'workflow_run'
        id: download-workflow-run
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: swarm_compute_reward_score.yml
          run_id: ${{ github.event.workflow_run.id }}
          name: reward-pr-*
          name_is_regexp: true
          path: ./artifacts
          if_no_artifact_found: ignore

      - name: Download reward artifacts from multiple runs
        if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Download artifacts from all recent successful runs
          RUN_IDS="${{ steps.get-run-ids.outputs.run_ids }}"
          if [ -z "$RUN_IDS" ]; then
            echo "No run IDs to process"
            exit 0
          fi
          
          mkdir -p ./artifacts
          
          IFS=',' read -ra RUN_ID_ARRAY <<< "$RUN_IDS"
          for RUN_ID in "${RUN_ID_ARRAY[@]}"; do
            echo "Downloading artifacts from run $RUN_ID..."
            # List artifacts for this run using API and download reward-pr-* artifacts
            ARTIFACT_NAMES=$(gh api repos/cseek11/VeroSuite/actions/runs/$RUN_ID/artifacts --jq '.artifacts[] | select(.name | startswith("reward-pr-")) | .name' 2>/dev/null || echo "")
            if [ -n "$ARTIFACT_NAMES" ]; then
              echo "$ARTIFACT_NAMES" | while read -r ARTIFACT_NAME; do
                if [ -n "$ARTIFACT_NAME" ]; then
                  echo "  Downloading artifact: $ARTIFACT_NAME"
                  # Download to a unique subdirectory to avoid conflicts
                  ARTIFACT_DIR="./artifacts/$ARTIFACT_NAME"
                  mkdir -p "$ARTIFACT_DIR"
                  gh run download $RUN_ID --name "$ARTIFACT_NAME" --dir "$ARTIFACT_DIR" || echo "Failed to download $ARTIFACT_NAME"
                fi
              done
            else
              echo "  No reward artifacts found for run $RUN_ID"
            fi
          done
          
          echo "Artifact download complete"
          ls -laR ./artifacts/ || echo "No artifacts directory"

      - name: Verify and process artifacts
        id: verify-artifacts
        run: |
          echo "Listing artifact contents:"
          ls -laR ./artifacts/ || echo "No artifacts directory found"
          
          # Find all reward.json files
          REWARD_FILES=$(find ./artifacts -name "reward.json" -type f 2>/dev/null || echo "")
          
          if [ -z "$REWARD_FILES" ]; then
            echo "⚠️ WARNING: No reward.json files found in artifacts"
            echo "This may occur if the parent workflow did not produce reward artifacts"
            echo "Skipping metrics update (non-blocking)"
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          echo "found=true" >> "$GITHUB_OUTPUT"
          
          # Count files
          FILE_COUNT=$(echo "$REWARD_FILES" | wc -l | tr -d ' ')
          echo "Found $FILE_COUNT reward.json file(s)"
          
          # Validate all JSON files and list them
          echo "$REWARD_FILES" | while read -r REWARD_FILE; do
            if [ -n "$REWARD_FILE" ]; then
              echo "Validating: $REWARD_FILE"
              python3 << EOF
          import json
          try:
              with open('$REWARD_FILE', 'r') as f:
                  data = json.load(f)
              # Handle both old and new field names
              pr_num = data.get('pr_number') or (data.get('metadata', {}) or {}).get('pr', 'unknown')
              score = data.get('total_score') or data.get('score', 'unknown')
              print(f"✓ Valid JSON (PR #{pr_num}, score: {score})")
          except Exception as e:
              print(f"✗ Invalid JSON in $REWARD_FILE: {e}")
          EOF
            fi
          done
          
          # Output reward files as multiline (using delimiter)
          {
            echo "reward_files<<EOF"
            echo "$REWARD_FILES"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Update metrics
        if: steps.verify-artifacts.outputs.found == 'true'
        run: |
          # Process all reward files found
          REWARD_FILES="${{ steps.verify-artifacts.outputs.reward_files }}"
          
          if [ -z "$REWARD_FILES" ]; then
            echo "No reward files to process"
            exit 1
          fi
          
          # Process each reward file (handle multiline output)
          echo "$REWARD_FILES" | while IFS= read -r REWARD_FILE; do
            if [ -n "$REWARD_FILE" ] && [ -f "$REWARD_FILE" ]; then
              echo "Processing: $REWARD_FILE"
              python3 .cursor/scripts/collect_metrics.py \
                --reward-file "$REWARD_FILE" \
                --output docs/metrics/reward_scores.json
            else
              echo "Skipping invalid file: $REWARD_FILE"
            fi
          done
          
          echo "Metrics update complete"

      - name: Commit and push metrics
        if: steps.verify-artifacts.outputs.found == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # collect_metrics.py writes directly to docs/metrics/reward_scores.json
          METRICS_FILE="docs/metrics/reward_scores.json"
          
          if [ ! -f "$METRICS_FILE" ]; then
            echo "Metrics file not found at $METRICS_FILE"
            exit 1
          fi
          
          echo "Checking metrics file: $METRICS_FILE"
          FILE_SIZE=$(stat -f%z "$METRICS_FILE" 2>/dev/null || stat -c%s "$METRICS_FILE" 2>/dev/null || echo "0")
          echo "File size: $FILE_SIZE bytes"
          
          if [ -s "$METRICS_FILE" ] && [ "$FILE_SIZE" -gt 0 ]; then
            echo "Metrics file has content, checking for changes..."
            git status
            git add "$METRICS_FILE"
            git status
            if git diff --cached --quiet; then
              echo "No changes to commit (file unchanged)"
            else
              echo "Changes detected, committing..."
              git commit -m "chore: update REWARD_SCORE metrics [skip ci]"
              echo "Pushing to main..."
              git push origin main || echo "Push failed (may need permissions)"
            fi
          else
            echo "Metrics file is empty or invalid, skipping commit"
            exit 1
          fi

      - name: Upload metrics artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: metrics-data
          path: docs/metrics/reward_scores.json
          retention-days: 30
        continue-on-error: true

