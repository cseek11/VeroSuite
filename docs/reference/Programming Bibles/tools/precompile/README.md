# Bible Preprocessing System

A shared, configurable system for splitting large markdown "bible" textbooks into manageable chapters and merging them back for SSM compilation.

## Overview

This system solves the problem of editing large markdown files (10,000+ lines) that cause memory issues and crashes in editors like Cursor. It splits monolithic bible files into individual chapter files for editing, then merges them back into a single file for SSM compilation.

## Architecture

- **Shared scripts** in `tools/precompile/` that work with any bible
- **Per-bible configuration** in `bibles/{bible_name}/config/bible_config.yaml`
- **Isolated workspaces** - each bible has its own `chapters/`, `config/`, and `dist/` directories

## Directory Structure

```
bibles/
  {bible_name}/
    source/              # Source markdown file
    config/
      bible_config.yaml  # Pattern definitions, slug rules
      book.yaml         # Generated chapter structure
    chapters/           # Individual chapter files
    dist/
      book_raw.md       # Merged output for SSM compiler
      book.ssm.md       # Final SSM output (not edited)

tools/
  precompile/
    split_book.py       # Split monolithic MD â†’ chapters
    merge_book.py       # Merge chapters â†’ book_raw.md
    loaders/            # Configuration and pattern loaders
```

## Usage

### 1. Split a Bible File

Split a monolithic markdown file into chapter files:

```bash
python tools/precompile/split_book.py \
  --config bibles/python_bible/config/bible_config.yaml \
  --input bibles/python_bible/source/Python_Bible_V3.md \
  --output bibles/python_bible/chapters/ \
  --book-yaml bibles/python_bible/config/book.yaml \
  [--verbose] [--dry-run]
```

**Options:**
- `--config`: Path to `bible_config.yaml` with pattern definitions
- `--input`: Path to source markdown file
- `--output`: Directory to write chapter files
- `--book-yaml`: Path to write generated `book.yaml` structure file
- `--verbose`: Enable detailed logging
- `--dry-run`: Process without writing files

### 2. Merge Chapter Files

Merge chapter files back into a single file for SSM compilation:

```bash
python tools/precompile/merge_book.py \
  --book-yaml bibles/python_bible/config/book.yaml \
  --output bibles/python_bible/dist/book_raw.md \
  [--inject-parts] [--verbose] [--dry-run]
```

**Options:**
- `--book-yaml`: Path to `book.yaml` structure file (generated by split)
- `--output`: Path to write merged `book_raw.md` file
- `--base-dir`: Base directory for resolving chapter paths (default: book_yaml parent parent)
- `--inject-parts`: Inject part headers into merged output
- `--verbose`: Enable detailed logging
- `--dry-run`: Process without writing files

### 3. Complete Workflow

```bash
# One-time setup: Split the bible
python tools/precompile/split_book.py \
  --config bibles/python_bible/config/bible_config.yaml \
  --input bibles/python_bible/source/Python_Bible_V3.md \
  --output bibles/python_bible/chapters/ \
  --book-yaml bibles/python_bible/config/book.yaml

# Edit chapters in bibles/python_bible/chapters/*.md

# Build: Merge and compile
python tools/precompile/merge_book.py \
  --book-yaml bibles/python_bible/config/book.yaml \
  --output bibles/python_bible/dist/book_raw.md

# SSM compilation (external tool)
python opa_ssm_compiler/main.py \
  bibles/python_bible/dist/book_raw.md \
  bibles/python_bible/dist/book.ssm.md \
  --v3 \
  --namespace python_bible
```

## Configuration File Format

Each bible requires a `bible_config.yaml` file that defines:

### Required Fields

- **chapter_boundary_patterns**: List of regex patterns to detect chapter starts
  - Checked in order, first match wins
  - Must capture chapter number in group 1
  - Example: `'^<!--\s*SSM:CHUNK_BOUNDARY\s+id="ch(\d+)-start"\s*-->$'`

- **chapter_title_patterns**: List of regex patterns to extract chapter titles
  - Must capture chapter number in group 1, title in group 2
  - Example: `'^ðŸ“˜\s*CHAPTER\s+(\d+)\s+[-â€”]\s+(.*)$'`

### Optional Fields

- **part_header_patterns**: List of regex patterns for part headers
  - Must capture part identifier in group 1, part name in group 2
  - Example: `'^#\s*Part\s+([IVXLC]+):\s*(.*)$'`

- **slug_rules**: Configuration for filename generation
  - `remove_emoji`: boolean (default: true)
  - `lowercase`: boolean (default: true)
  - `replace_non_alnum_with_space`: boolean (default: true)
  - `collapse_whitespace`: boolean (default: true)

- **book_metadata**: Book metadata for SSM compilation
  - `title`: Book title (required)
  - `version`: Version string (default: "1.0.0")
  - `namespace`: SSM namespace (optional)

### Example Configuration

```yaml
# Chapter boundary patterns (checked in order)
chapter_boundary_patterns:
  - '^<!--\s*SSM:CHUNK_BOUNDARY\s+id="ch(\d+)-start"\s*-->$'

# Chapter title patterns
chapter_title_patterns:
  - '^ðŸ“˜\s*CHAPTER\s+(\d+)\s+[-â€”]\s+(.*)$'

# Part header patterns (optional)
part_header_patterns:
  - '^#\s*Part\s+([IVXLC]+):\s*(.*)$'

# Slug generation rules
slug_rules:
  remove_emoji: true
  lowercase: true
  replace_non_alnum_with_space: true
  collapse_whitespace: true

# Book metadata
book_metadata:
  title: "Python Bible"
  version: "3.0.0"
  namespace: "python_bible"
```

## How It Works

### Splitting Process

1. **Load Configuration**: Read `bible_config.yaml` and compile regex patterns
2. **Read Source File**: Load the monolithic markdown file line-by-line
3. **Pattern Matching**: For each line:
   - Check chapter boundary patterns (highest priority)
   - Check chapter title patterns (secondary)
   - Check part header patterns (metadata only)
   - Append to current chapter buffer
4. **Chapter Finalization**: When a new chapter starts:
   - Write previous chapter to file: `{N:02d}_{slugified_title}.md`
   - Store chapter metadata
5. **Generate Structure**: Create `book.yaml` with chapter organization

### Merging Process

1. **Load Structure**: Read `book.yaml` generated by split
2. **Validate Files**: Check that all chapter files exist
3. **Merge Chapters**: For each part and chapter:
   - Optionally inject part headers
   - Read chapter file content
   - Remove trailing newlines
   - Write with exactly one blank line separator
4. **Write Output**: Create `book_raw.md` ready for SSM compilation

## Key Features

- **Configurable Patterns**: No hardcoded bible-specific patterns
- **Content Preservation**: Exact byte-for-byte preservation of chapter content
- **Generalizable**: Works for any bible with appropriate configuration
- **Isolated Workspaces**: Each bible's data is separate
- **Shared Logic**: All bibles use same split/merge algorithms
- **SSM Compatible**: Output matches SSM v3 compiler expectations

## Design Principles

1. **No Hardcoded Patterns**: All regex patterns loaded from config
2. **Content Preservation**: Exact preservation of SSM blocks, HTML comments, Mermaid, code fences
3. **Generalizable**: Works for Python Bible, TypeScript Bible, REGO Bible, etc.
4. **Isolated Workspaces**: Each bible has its own chapters/config/dist folders
5. **Shared Logic**: All bibles use same split/merge algorithms

## Dependencies

- Python 3.8+
- PyYAML (for YAML parsing)
- Standard library: `re`, `pathlib`, `argparse`, `logging`

## Troubleshooting

### Missing Chapter Files

If merge fails with "chapter file not found", check:
- Chapter paths in `book.yaml` are relative to the base directory
- Base directory is set correctly (default: `book.yaml` parent parent)
- Chapter files were generated by split

### Pattern Not Matching

If chapters aren't being detected:
- Check regex patterns in `bible_config.yaml`
- Use `--verbose` flag to see pattern matching debug output
- Verify patterns match your source file format
- Test patterns with a regex tester

### Duplicate Chapter Numbers

If you see warnings about duplicate chapters:
- Check source file for duplicate chapter numbers
- Verify boundary and title patterns aren't conflicting
- Review chapter numbering in source file

## Adding a New Bible

1. Create bible directory: `bibles/{bible_name}/`
2. Create subdirectories: `source/`, `config/`, `chapters/`, `dist/`
3. Create `config/bible_config.yaml` with patterns matching your bible format
4. Place source file in `source/`
5. Run split to generate chapters
6. Edit chapters as needed
7. Run merge to create `dist/book_raw.md`
8. Compile with SSM compiler

## License

Part of the VeroField Training Bible system.


