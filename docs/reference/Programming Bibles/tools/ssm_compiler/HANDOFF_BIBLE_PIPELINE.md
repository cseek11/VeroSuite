# Hand-Off: SSM → Cursor Ingestion Pipeline

## Overview

This document describes the next phase of the Bible compilation system: converting SSM-compiled Bibles into Cursor-friendly formats for AI agent consumption.

## Current State

✅ **Completed:**
- V3 SSM Compiler (`opa_ssm_compiler/`) - Converts markdown Bibles → SSM v3 format
- SSM Output: `*.ssm.md` files with structured blocks (chapter-meta, concept, fact, antipattern, pattern, qa, etc.)
- Validation & Quality: All V3 features implemented (symbol-table, compile-summary, deduplication, etc.)

## Target Architecture (3-Layer Pipeline)

For each language Bible (Rego, Python, TypeScript, NestJS, Prisma, Cursor Rules, etc.):

### Layer 1: Source Bible (Authoring)
```
knowledge/bibles/<lang>/source/<Lang>_Bible.md
```
- Human-authored, pedagogical documentation
- Large markdown files with chapters, examples, patterns

### Layer 2: Machine Bible (SSM, from V3 compiler)
```
knowledge/bibles/<lang>/compiled/<Lang>_Bible.ssm.md
```
- Generated by V3 SSM compiler (already built)
- Structured semantic markup with blocks, metadata, relationships

### Layer 3: Cursor-Facing Outputs (for agents)
```
knowledge/bibles/<lang>/cursor/<Lang>_Bible.cursor.md  # Knowledge (for reading & reasoning)
.cursor/rules/<lang>_bible.mdc                         # Rules (for enforcement)
```

**Cursor Behavior:**
- Reads `*.cursor.md` as rich documentation
- Enforces `.cursor/rules/*.mdc` as rules/policies
- Ignores `*.ssm.md` (for compiler + RAG stack)

## Directory Layout Template

Reusable structure for any Bible:

```
/knowledge/
  /bibles/
    /rego/
      /source/
        REGO_OPA_Bible.md
      /compiled/
        REGO_OPA_Bible.ssm.md
      /cursor/
        REGO_OPA_Bible.cursor.md   # Cursor-readable doc

    /python/
      /source/
        Python_Bible.md
      /compiled/
        Python_Bible.ssm.md
      /cursor/
        Python_Bible.cursor.md

    /typescript/
      /source/
        TypeScript_Bible.md
      /compiled/
        TypeScript_Bible.ssm.md
      /cursor/
        TypeScript_Bible.cursor.md

/.cursor/
  /rules/
    rego_bible.mdc
    python_bible.mdc
    typescript_bible.mdc
```

## Implementation Steps

### Step 1: Create Pipeline Script
- Location: `tools/bible_pipeline.py`
- Purpose: Parse SSM → Generate Cursor outputs
- Generic: Works for any language Bible

### Step 2: Set Up Directory Structure
- Create `knowledge/bibles/` hierarchy
- Migrate existing Bibles to new structure
- Set up `.cursor/rules/` for Bible rules

### Step 3: Create Build Automation
- Makefile or Python script for end-to-end pipeline
- Support for: compile (source → SSM) and ingest (SSM → Cursor)

### Step 4: Test with Existing Bibles
- Rego Bible: `docs/reference/Rego_OPM_BIBLE/rego_opa_bible.md`
- Python Bible: `docs/reference/Python_Bible_backup_v2.md`

## Pipeline Script Features

The `bible_pipeline.py` script will:

1. **Parse SSM Blocks** - Read `.ssm.md` files into structured blocks
2. **Generate Cursor Markdown** - Create human/agent-readable documentation:
   - Chapter-organized content
   - Key concepts, facts, patterns
   - Anti-patterns with severity
   - Representative Q&A
3. **Generate Cursor Rules** - Create enforcement rules:
   - Anti-patterns → DO NOT rules
   - Code patterns → Recommended patterns
   - Constraints → Enforcement guidelines

## Usage Examples

```bash
# For Rego Bible
python tools/bible_pipeline.py \
  --language rego \
  --ssm knowledge/bibles/rego/compiled/REGO_OPA_Bible.ssm.md \
  --out-md knowledge/bibles/rego/cursor/REGO_OPA_Bible.cursor.md \
  --out-mdc .cursor/rules/rego_bible.mdc

# For Python Bible
python tools/bible_pipeline.py \
  --language python \
  --ssm knowledge/bibles/python/compiled/Python_Bible.ssm.md \
  --out-md knowledge/bibles/python/cursor/Python_Bible.cursor.md \
  --out-mdc .cursor/rules/python_bible.mdc
```

## Build Automation

Makefile targets for end-to-end pipeline:

```makefile
# Compile: source → SSM
bible-rego-ssm: knowledge/bibles/rego/compiled/REGO_OPA_Bible.ssm.md

# Ingest: SSM → Cursor
bible-rego-cursor: knowledge/bibles/rego/cursor/REGO_OPA_Bible.cursor.md .cursor/rules/rego_bible.mdc

# Full pipeline
bible-rego: bible-rego-ssm bible-rego-cursor
```

## Implementation Status

✅ **Completed:**
1. ✅ Created `tools/bible_pipeline.py` script
2. ✅ Set up `knowledge/bibles/` directory structure
3. ✅ Created `tools/bible_build.py` automation script
4. ✅ Created `tools/Makefile.bibles` for Make-based builds
5. ✅ Tested with Python Bible (6,489 blocks processed)
6. ✅ Generated sample outputs verified

## Next Actions

1. ⏳ Test with Rego Bible
2. ⏳ Add to main project README
3. ⏳ Set up CI/CD integration (optional)
4. ⏳ Add more languages (TypeScript, NestJS, etc.)

## Design Principles

- **Generic**: Same script works for all languages
- **Conservative**: Works with existing V3 SSM output
- **Non-invasive**: Doesn't modify SSM format
- **Cursor-optimized**: Outputs tailored for AI agent consumption

---

**Last Updated:** 2025-12-05  
**Status:** Ready for Implementation  
**Owner:** Engineering Team

