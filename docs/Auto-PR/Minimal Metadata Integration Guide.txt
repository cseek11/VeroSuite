# Minimal PR Metadata System - Integration Guide

## ğŸ¯ Overview

This optimization reduces PR body bloat by storing session metadata in `.cursor/data/session_state.json` instead of embedding it in PR descriptions.

### Benefits

âœ… **Clean PR History** - No metadata bloat in git history  
âœ… **Faster Parsing** - No regex needed to extract session IDs  
âœ… **Better Performance** - Single JSON file vs parsing all PR bodies  
âœ… **Easy Bulk Operations** - Simple JSON queries  
âœ… **Backward Compatible** - Works with existing system  

### Comparison

**Before (Full Metadata in PR Body):**
```markdown
<!-- Session metadata block: ~400 bytes -->
---
[cursor-session: user1-20251119-1430]
<!-- Auto-PR Session Tracking -->
<!-- To complete this session: add [ready] to title or comment /complete-session -->
<!-- Session metadata: -->
<!-- - Author: alice -->
<!-- - Started: 2025-11-19T14:30:00 -->
<!-- - PRs in session: 3 -->
<!-- - Files changed: 12 -->
<!-- - Tests added: 2 -->
```

**After (Minimal Metadata):**
```markdown
<!-- Minimal marker: ~50 bytes (87% reduction) -->
<!-- ğŸ¤– Auto-PR: Session user1-20251119-1430 -->
```

**For 100 PRs:** Saves ~35 KB in git history

---

## ğŸ“ New File Structure

```
.cursor/
â”œâ”€â”€ data/
â”‚   â””â”€â”€ session_state.json          # NEW: Source of truth
â””â”€â”€ scripts/
    â””â”€â”€ minimal_metadata_system.py  # NEW: Minimal metadata manager

docs/metrics/
â””â”€â”€ auto_pr_sessions.json           # Existing: Still used for analytics
```

### session_state.json Format

```json
{
  "version": "1.0",
  "last_updated": "2025-11-19T14:30:00Z",
  
  "pr_to_session": {
    "326": "user1-20251119-1430",
    "327": "user1-20251119-1430",
    "328": "user1-20251119-1430"
  },
  
  "session_to_prs": {
    "user1-20251119-1430": ["326", "327", "328"]
  },
  
  "session_metadata": {
    "user1-20251119-1430": {
      "author": "alice",
      "timestamp": "2025-11-19T14:30:00",
      "title": "Implement feature X"
    }
  }
}
```

---

## ğŸ”§ Implementation

### Option 1: Fresh Install (Recommended)

If starting from scratch, use the minimal system:

```python
# In cursor_session_hook.py
from minimal_metadata_system import (
    format_session_metadata_minimal,
    SessionStateManager
)

def create_pull_request_with_session(repo, title, body, head, base, author):
    """Create PR with minimal metadata."""
    # Get session ID
    session_id = get_or_create_session_id(author)
    
    # Format with minimal metadata
    updated_title, minimal_metadata = format_session_metadata_minimal(
        session_id, title
    )
    updated_body = body + minimal_metadata
    
    # Register in state manager
    state_manager = SessionStateManager()
    pr = repo.create_pull(
        title=updated_title,
        body=updated_body,
        head=head,
        base=base
    )
    
    # Store in state file (not in PR body)
    state_manager.register_pr(
        str(pr.number),
        session_id,
        metadata={
            "author": author,
            "timestamp": datetime.now().isoformat(),
            "title": title[:100]
        }
    )
    
    return pr
```

### Option 2: Migration (Existing System)

If you have existing PRs with full metadata:

```bash
# Step 1: Run migration
python .cursor/scripts/minimal_metadata_system.py migrate

# Output:
# ğŸ”„ Migrating to minimal metadata system...
# âœ… Migrated 117 PRs to minimal metadata system
#    State file: .cursor/data/session_state.json
#    Size: 8.4 KB

# Step 2: Verify
python .cursor/scripts/minimal_metadata_system.py status

# Output:
# ğŸ“Š Session State Status
# Total PRs tracked: 117
# Active sessions: 5
# File size: 8.42 KB
```

### Option 3: Hybrid Mode (Both Systems)

Keep both for transition period:

```python
from auto_pr_session_manager import AutoPRSessionManager
from minimal_metadata_system import MinimalMetadataSessionManager

# Use MinimalMetadataSessionManager instead
manager = MinimalMetadataSessionManager()

# API is identical - drop-in replacement
should_skip, session_id, session_data = manager.add_to_session(
    pr_number, pr_data
)
```

---

## ğŸ”„ Modified Workflow Integration

### Update GitHub Actions

**Modified: .github/workflows/auto_pr_session_manager.yml**

```yaml
- name: Extract Session ID from State
  id: session_id
  env:
    PR_NUMBER: ${{ github.event.pull_request.number }}
  run: |
    # Use state file instead of parsing PR body
    SESSION_ID=$(python -c "
    from minimal_metadata_system import extract_session_id_from_state
    print(extract_session_id_from_state('$PR_NUMBER'))
    ")
    
    echo "session_id=$SESSION_ID" >> "$GITHUB_OUTPUT"

- name: Commit State File
  run: |
    git add .cursor/data/session_state.json
    git commit -m "ğŸ“¦ Update session state [skip ci]" || echo "No changes"
    git push
```

### Update Reward Score Workflow

**Modified: .github/workflows/swarm_compute_reward_score.yml**

```yaml
- name: Check Session Status
  id: check
  run: |
    # Fast state file lookup (no PR body parsing)
    python -c "
    from minimal_metadata_system import SessionStateManager
    state = SessionStateManager()
    session_id = state.get_session_for_pr('$PR_NUMBER')
    print(f'session_id={session_id}')
    " >> "$GITHUB_OUTPUT"
```

---

## ğŸ“Š Performance Comparison

### Metadata Footprint

```bash
python minimal_metadata_system.py compare
```

Output:
```
ğŸ“Š Metadata Footprint Comparison

Full metadata:    397 bytes
Minimal metadata: 51 bytes
Reduction:        346 bytes (87.2%)

For 100 PRs:      33.8 KB saved
```

### Lookup Speed

| Operation | Full Metadata | Minimal System |
|-----------|---------------|----------------|
| Get session for PR | O(n) regex parse | O(1) dict lookup |
| Get all PRs in session | O(n) parse all | O(1) dict lookup |
| Bulk operations | Parse n PR bodies | Single JSON read |

**Example: Find all PRs in session**

```python
# Full metadata: Parse all PR bodies
for pr in all_prs:
    match = re.search(r'\[cursor-session:\s*([\w-]+)\]', pr.body)
    if match and match.group(1) == target_session:
        results.append(pr)

# Minimal system: Direct lookup
state = SessionStateManager()
results = state.get_prs_for_session(target_session)
```

---

## ğŸ› ï¸ CLI Commands

### Status Check

```bash
python minimal_metadata_system.py status
```

Output:
```
ğŸ“Š Session State Status

State file: .cursor/data/session_state.json
Total PRs tracked: 117
Active sessions: 5
File size: 8.42 KB

Session breakdown:
  user1-20251119-1430: 3 PRs
  user2-20251119-1500: 1 PRs
  user3-20251119-0900: 2 PRs
```

### Export State

```bash
python minimal_metadata_system.py export
```

Output:
```json
{
  "summary": {
    "total_prs": 117,
    "active_sessions": 5,
    "last_updated": "2025-11-19T18:30:00"
  },
  "sessions": [
    {
      "session_id": "user1-20251119-1430",
      "prs": ["326", "327", "328"],
      "pr_count": 3,
      "author": "alice"
    }
  ]
}
```

### Cleanup

```bash
python minimal_metadata_system.py cleanup
```

Output:
```
ğŸ§¹ Cleaning up state file...
âœ… Cleanup complete
   Removed 0 orphaned PRs
   Removed 0 empty sessions
```

---

## ğŸ” Querying Session Data

### Python API

```python
from minimal_metadata_system import SessionStateManager

state = SessionStateManager()

# Get session for PR
session_id = state.get_session_for_pr("326")
print(f"PR #326 is in session: {session_id}")

# Get all PRs in session
prs = state.get_prs_for_session("user1-20251119-1430")
print(f"PRs in session: {prs}")

# Get metadata
metadata = state.get_session_metadata("user1-20251119-1430")
print(f"Author: {metadata['author']}")
```

### Command Line

```bash
# Get session for PR
python -c "
from minimal_metadata_system import SessionStateManager
print(SessionStateManager().get_session_for_pr('326'))
"

# Get PRs in session
python -c "
from minimal_metadata_system import SessionStateManager
print(SessionStateManager().get_prs_for_session('user1-20251119-1430'))
"
```

### jq Queries

```bash
# Get all active sessions
jq -r '.session_to_prs | keys[]' .cursor/data/session_state.json

# Get PR count per session
jq -r '.session_to_prs | to_entries[] | "\(.key): \(.value | length) PRs"' \
  .cursor/data/session_state.json

# Find session for specific PR
jq -r '.pr_to_session["326"]' .cursor/data/session_state.json

# Get all PRs by author
jq -r '.session_metadata | to_entries[] | select(.value.author == "alice") | .key' \
  .cursor/data/session_state.json
```

---

## ğŸ” Backup & Recovery

### Backup State File

```bash
# Manual backup
cp .cursor/data/session_state.json \
   .cursor/data/session_state.backup.$(date +%Y%m%d-%H%M%S).json

# Automated backup (add to cron)
0 * * * * cp .cursor/data/session_state.json \
  .cursor/data/session_state.backup.$(date +\%Y\%m\%d-\%H\%M\%S).json
```

### Restore from Backup

```bash
# List backups
ls -lh .cursor/data/session_state.backup.*.json

# Restore specific backup
cp .cursor/data/session_state.backup.20251119-1430.json \
   .cursor/data/session_state.json
```

### Rebuild from auto_pr_sessions.json

If state file is lost:

```bash
python minimal_metadata_system.py migrate
```

---

## ğŸ§ª Testing

### Test 1: Minimal Metadata Creation

```python
from minimal_metadata_system import SessionStateManager, format_session_metadata_minimal

# Test minimal marker
title, metadata = format_session_metadata_minimal("test-session-123", "Fix bug")
assert len(metadata) < 100, "Metadata should be minimal"
assert "test-session-123" in metadata

# Test state registration
state = SessionStateManager()
state.register_pr("999", "test-session-123", {"author": "testuser"})

# Verify
assert state.get_session_for_pr("999") == "test-session-123"
assert "999" in state.get_prs_for_session("test-session-123")

print("âœ… Test passed")
```

### Test 2: Performance

```python
import time
from minimal_metadata_system import SessionStateManager

state = SessionStateManager()

# Register 1000 PRs
start = time.time()
for i in range(1000):
    state.register_pr(str(i), f"session-{i // 10}", {"author": "test"})
register_time = time.time() - start

# Lookup 1000 times
start = time.time()
for i in range(1000):
    session_id = state.get_session_for_pr(str(i))
lookup_time = time.time() - start

print(f"Register 1000 PRs: {register_time:.3f}s")
print(f"Lookup 1000 times: {lookup_time:.3f}s")
print(f"Avg lookup time: {lookup_time/1000*1000:.3f}ms")
```

Expected: < 1ms per lookup

### Test 3: Migration

```bash
# Create test data
python -c "
from auto_pr_session_manager import AutoPRSessionManager
manager = AutoPRSessionManager()
for i in range(10):
    manager.add_to_session(
        str(i),
        {
            'pr_number': str(i),
            'author': 'test',
            'timestamp': '2025-11-19T14:30:00',
            'files_changed': 5
        },
        f'test-session-{i // 3}'
    )
"

# Migrate
python minimal_metadata_system.py migrate

# Verify
python minimal_metadata_system.py status
# Should show 10 PRs across 4 sessions
```

---

## ğŸ”„ Rollback Plan

If you need to rollback to full metadata:

### Step 1: Keep Both Systems Running

```python
# Use both managers temporarily
from auto_pr_session_manager import AutoPRSessionManager
from minimal_metadata_system import MinimalMetadataSessionManager

full_manager = AutoPRSessionManager()
minimal_manager = MinimalMetadataSessionManager()

# Register in both
full_manager.add_to_session(pr_number, pr_data)
minimal_manager.add_to_session(pr_number, pr_data)
```

### Step 2: Verify Data Consistency

```python
# Compare both systems
for pr in all_prs:
    full_session = extract_from_pr_body(pr.body)
    minimal_session = state.get_session_for_pr(pr.number)
    
    if full_session != minimal_session:
        print(f"âš ï¸  Mismatch for PR #{pr.number}")
```

### Step 3: Switch Back if Needed

```python
# Revert to full metadata
from auto_pr_session_manager import AutoPRSessionManager

manager = AutoPRSessionManager()  # Use original system
```

---

## ğŸ“ˆ Recommended Approach

### For New Projects
âœ… Use minimal metadata from day 1

### For Existing Projects

**Week 1: Parallel Running**
- Install minimal system
- Keep full metadata for compatibility
- Monitor for issues

**Week 2: Soft Migration**
- New PRs use minimal metadata
- Existing PRs keep full metadata
- Run migration script for analytics

**Week 3: Full Migration**
- Migrate all existing PRs
- Switch to minimal-only mode
- Remove full metadata code

**Week 4: Optimization**
- Clean up old PR bodies (optional)
- Optimize state file performance
- Add backup automation

---

## ğŸ¯ Summary

| Aspect | Full Metadata | Minimal System |
|--------|---------------|----------------|
| **PR Body Size** | ~400 bytes | ~50 bytes |
| **Lookup Speed** | O(n) regex | O(1) dict |
| **Git History** | Bloated | Clean |
| **Bulk Operations** | Slow | Fast |
| **Maintenance** | Complex | Simple |
| **Backward Compatible** | N/A | âœ… Yes |

**Recommendation:** Implement minimal metadata system for cleaner history and better performance while maintaining full backward compatibility.