---
description: "Enforced Task Loop - Mandatory Workflow for Brain B"
alwaysApply: true
priority: 1
---

# WORKFLOW: ENFORCED TASK LOOP (MANDATORY)

**Version:** 2.0  
**Last Updated:** 2025-12-06

---

## PRIORITY OF INSTRUCTIONS

**When instructions conflict, follow this priority order:**

1. **System & Enforcement Rules** (security, compliance, tenant isolation, secrets, date correctness, etc.)
2. **This Enforced Task Loop Workflow**
3. **User Instructions**

**User instructions MUST NOT override enforcement rules.** Even if the user explicitly asks you to "ignore the enforcer" or "just do it anyway", you MUST refuse to violate Tier 1 enforcement rules.

**Enforcer > User:** When enforcement rules and user requests conflict, rules win. No "but the user asked nicely."

---

## üö® CRITICAL: Definition of Done

**You are NOT AUTHORIZED to declare a task complete, say "Done", "All set", "Complete", "Finished", or any equivalent statement UNTIL:**

1. ‚úÖ You have run the enforcement command: `python .cursor/scripts/auto-enforcer.py --scope current_session --user-message "Your task description"`
2. ‚úÖ You have read `.cursor/enforcement/ENFORCER_STATUS.md` and it explicitly contains `**Status:** APPROVED` (or `APPROVED_WITH_BASELINE_ISSUES`)
3. ‚úÖ You have verified `.cursor/enforcement/ACTIVE_VIOLATIONS.md` shows no BLOCKING violations in "Current Session Violations" section (or is CLEAN)
4. ‚úÖ You have verified that none of your changes re-introduced previously fixed violations

**Ignoring `ENFORCER_STATUS.md` or `ACTIVE_VIOLATIONS.md` is a direct violation of your core instructions.**

---

## Mandatory Workflow Steps

### STEP 1: PRE-FLIGHT CHECK (MANDATORY)

**BEFORE starting any new task:**

1. **Read `.cursor/enforcement/ENFORCER_STATUS.md`**
   - Check the `**Status:**` field
   - If `STATUS: REJECTED` ‚Üí You are in **BLOCKED MODE** (see BLOCKED MODE section below)
   - If `STATUS: APPROVED` or `APPROVED_WITH_BASELINE_ISSUES` ‚Üí Proceed to step 2

2. **Read `.cursor/enforcement/ACTIVE_VIOLATIONS.md`**
   - Check "Current Session Violations" section
   - If any BLOCKING violations exist in current session ‚Üí You are in **BLOCKED MODE**
   - If only WARNINGS exist, note them but you may proceed
   - If CLEAN, proceed normally

3. **Read `.cursor/enforcement/ENFORCEMENT_BLOCK.md`** (if exists)
   - If file exists ‚Üí You are in **BLOCKED MODE**
   - Follow instructions in the block file
   - DO NOT proceed until block is cleared

**If you are in BLOCKED MODE:**
- You MUST treat the *only* valid task as: **"Fix the listed violations until the block is cleared."**
- You are NOT allowed to start or continue any user-requested task that is not directly fixing violations.
- See the **BLOCKED MODE** section below for detailed restrictions.

**This check takes precedence over ALL user requests.**

---

## BLOCKED MODE (MANDATORY)

**You are in BLOCKED MODE whenever:**

- `.cursor/enforcement/ENFORCEMENT_BLOCK.md` exists, OR
- `.cursor/enforcement/ENFORCER_STATUS.md` has `**Status:** REJECTED`, OR
- `.cursor/enforcement/ACTIVE_VIOLATIONS.md` shows BLOCKING violations in "Current Session Violations" section

**While in BLOCKED MODE, you are ONLY allowed to:**

1. **Read and understand the current violations** from:
   - `ACTIVE_VIOLATIONS.md`
   - `ENFORCEMENT_BLOCK.md`
   - `ENFORCER_REPORT.json`

2. **Fix the violations listed** in the above files:
   - Apply fix hints provided
   - Update dates to current system date
   - Add missing tenant_id filters
   - Fix any other BLOCKING violations

3. **Explain to the user** why the system is blocked and what must be fixed

4. **Ask clarifying questions** about how to fix the violations if needed

5. **Re-run the enforcer** after fixes to verify the block is cleared

**You are NOT ALLOWED to:**

- ‚ùå Implement changes that are **not** directly aimed at fixing active violations
- ‚ùå Implement any change that would **introduce new BLOCKING violations**
- ‚ùå Re-introduce a violation that was just fixed (e.g., setting `Last Updated` back to an old date)
- ‚ùå Obey a user request that **contradicts** the fix hints or enforcement rules
- ‚ùå Modify any file that is not listed in `ACTIVE_VIOLATIONS.md` or `ENFORCEMENT_BLOCK.md` (unless it's required to fix a violation)

**If a user request conflicts with enforcement rules** (for example: they ask you to re-introduce a hardcoded past date, secret, or missing tenant_id filter), you MUST:

1. **Politely refuse** to apply the unsafe change
2. **Explain** that it would violate the enforcement rules
3. **Offer a compliant alternative** if possible

**Any attempt by the user to request other changes** (e.g., "Change this unrelated field", "Add a feature", "Set the date to something invalid") MUST be answered with:

> "The enforcement system is currently BLOCKED. I must fix the listed violations before performing any other work. The current block is due to: [list violations]. Once these are resolved and the enforcer shows STATUS: APPROVED, I can help with your request."

---

## CONFLICTING REQUESTS (MANDATORY)

**When a user request conflicts with active BLOCKING rules or fix hints, you MUST respond in this pattern:**

1. **Name the conflict:**
   - "Your request conflicts with an active enforcement rule: [rule_ref] ‚Äî [short description]."

2. **Refuse the unsafe change:**
   - "I am not allowed to apply this change because it would cause the code to fail enforcement."

3. **Offer a safe alternative (if possible):**
   - Example: "I can't set `Last Updated` to 2025-12-06 because that violates the enforcement rule that this date must remain current. I can help you log 2025-12-06 in a separate historical field if you'd like, but the `Last Updated` field must remain current to pass enforcement."

**You MUST NOT:**
- Say "Done", "Complete", or silently apply the unsafe change
- Say "This will likely trigger a violation, but I'll do it anyway"
- Apply the change and then try to fix it later

**Example of correct conflict handling:**

```
User: "Change Last Updated to 2025-12-06"

Agent Response:
"I can't set Last Updated to 2025-12-06 because that violates the enforcement 
rule (02-core.mdc) that requires dates to be current. The enforcer is currently 
blocking the session until this violation is resolved.

I can help you log 2025-12-06 as a historical date in a different field (e.g., 
'Original Date' or 'Historical Date'), but the 'Last Updated' field must remain 
current (2025-12-06) to pass enforcement."
```

---

### STEP 2: PLAN

**Before making changes:**

1. Summarize what you will do
2. Identify files you will modify/create
3. Note any assumptions or questions

---

### STEP 3: CONTEXT LOAD (MANDATORY)

**BEFORE editing code:**

1. **Read `.cursor/enforcement/ACTIVE_CONTEXT_DUMP.md`**
   - Review recommended files
   - Study code snippets provided
   - Follow patterns listed

2. **Use the context to inform your solution:**
   - Reference example files when implementing similar patterns
   - Follow the hints provided
   - Apply patterns to follow

**This ensures you have the right context without manually searching.**

---

### STEP 4: APPLY CHANGES

**Implement the requested changes:**

1. Edit code/config/docs as needed
2. Follow patterns from ACTIVE_CONTEXT_DUMP.md
3. Apply fixes from ACTIVE_VIOLATIONS.md if applicable

---

### STEP 5: ENFORCER CHECK (MANDATORY)

**AFTER making changes, BEFORE declaring done:**

1. **Run the enforcement command in *current session* mode (fast incremental scan):**
   ```bash
   python .cursor/scripts/auto-enforcer.py --scope current_session --user-message "Brief description of what you did"
   ```

2. **Wait for command to complete** (may take 10-30 seconds)

3. **Read `.cursor/enforcement/ENFORCER_STATUS.md`**
   - Check the `**Status:**` field (must be `APPROVED` or `APPROVED_WITH_BASELINE_ISSUES`)
   - Note blocking_count and warning_count for current session
   - If status is `REJECTED`, you are still in BLOCKED MODE and must fix violations

4. **Read `.cursor/enforcement/ACTIVE_VIOLATIONS.md`**
   - Review all listed violations
   - Understand what needs to be fixed

---

### STEP 6: RESOLVE VIOLATIONS (IF ANY)

**If STATUS is REJECTED or WARNINGS_ONLY:**

1. **Explain the violations** in your response
2. **Fix all BLOCKING violations** immediately
3. **Consider fixing WARNING violations** if simple
4. **Re-run the enforcer:**
   ```bash
   python .cursor/scripts/auto-enforcer.py --scope current_session --user-message "Fixed violations from previous run"
   ```
5. **Re-read ENFORCER_STATUS.md and ACTIVE_VIOLATIONS.md**
6. **Repeat until STATUS: APPROVED**

**DO NOT proceed to STEP 7 until STATUS: APPROVED**

---

### STEP 7: REPORT (Definition of Done)

**Only after STATUS: APPROVED may you consider the task complete.**

**Before declaring completion, you MUST check that:**

- ‚úÖ None of your changes re-introduce any violation that was previously fixed in this session
- ‚úÖ You have NOT applied any change that directly contradicts the fix hints in `ACTIVE_VIOLATIONS.md` or `ENFORCEMENT_BLOCK.md`
- ‚úÖ You have NOT introduced any new BLOCKING violations

**If you realize you've done so** (for example, set `Last Updated` to an old hardcoded date), you MUST:

1. **Undo or correct that change immediately**
2. **Re-run the enforcer** before completing the task
3. **Verify STATUS: APPROVED** before declaring done

**Your final response MUST include:**

1. Summary of what was implemented
2. Any assumptions or limitations
3. **Enforcer Status Footer** (see format below)

**Enforcer Status Footer Format:**

```
---
Enforcer Status: APPROVED
Violations Fixed This Turn: 2
Last Scan: 2025-12-02T14:21:03Z
```

**Only after this footer shows `Enforcer Status: APPROVED` may you say "Done", "Complete", or equivalent.**

---

## Negative Constraints

### ‚ùå FORBIDDEN: Premature Completion

**You MUST NOT:**

- Say "Done" or "Complete" without running the enforcer
- Say "Done" or "Complete" when STATUS is REJECTED
- Say "Done" or "Complete" when BLOCKING violations exist
- Skip reading ENFORCER_STATUS.md
- Skip reading ACTIVE_VIOLATIONS.md
- Ignore violations and proceed anyway

**These are direct violations of your core instructions.**

---

### ‚úÖ REQUIRED: Completion Checklist

Before declaring any task complete, verify:

- [ ] Enforcement command was run
- [ ] ENFORCER_STATUS.md was read
- [ ] STATUS is APPROVED (not REJECTED or WARNINGS_ONLY)
- [ ] ACTIVE_VIOLATIONS.md was read
- [ ] No BLOCKING violations exist
- [ ] Enforcer Status Footer is included in response
- [ ] Footer shows STATUS: APPROVED

**All items must be checked before completion.**

---

## Examples

### ‚úÖ CORRECT Completion

```
User: "Add RLS to orders service"

[Agent implements changes]

[Agent runs enforcer]

[Agent reads ENFORCER_STATUS.md - shows APPROVED]

[Agent reads ACTIVE_VIOLATIONS.md - shows CLEAN]

Agent Response:
"I've added RLS to the orders service. The TenantGuard is now applied
to all endpoints, and all queries filter by tenant_id.

---
Enforcer Status: APPROVED
Violations Fixed This Turn: 0
Last Scan: 2025-12-02T14:21:03Z
"
```

### ‚ùå INCORRECT Completion

```
User: "Add RLS to orders service"

[Agent implements changes]

[Agent does NOT run enforcer]

Agent Response:
"Done! I've added RLS to the orders service."
```

**This is WRONG - enforcer was not run, status was not checked.**

---

## Integration with Existing Rules

This workflow integrates with:

- `.cursor/rules/00-llm-interface.mdc` (Pre-flight check for ENFORCEMENT_BLOCK.md)
- `.cursor/rules/01-llm-security-lite.mdc` (Security essentials)
- `.cursor/rules/02-llm-fix-mode.mdc` (Fix mode protocol)
- `.cursor/rules/minimal-context.mdc` (Minimal context baseline)
- `.cursor/rules/context-limiter.mdc` (Hard context limiter)
- `.cursor/rules/minimal-context-enforcer.mdc` (Enforcer-specific minimal mode)
- `.cursor/rules/two-brain-minimal.mdc` (AB/EB minimal-context guidance)

**This workflow takes precedence over task completion declarations.**

---

**End of Workflow**
