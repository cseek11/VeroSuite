---
description: "VeroForge master rule: CI integration, REWARD_SCORE, pattern extraction, and global precedence"
alwaysApply: true
---

# Cursor: Engineering Swarm — Optimized Rules (Cursor-native, CI-driven, Modular)

## RULE PRECEDENCE
This file (`.cursor/rules/00-master.mdc`) supersedes and overrides every other rule file in `.cursor/rules/` unless another section inside this file explicitly delegates control. If any legacy directive conflicts with guidance here, Cursor must obey this file first.

## VERSION & CHANGE CONTROL
- **Version:** 2.0 (2025-11-21)  
- **Change Log:** Track updates in `docs/architecture/cursor_rules_upgrade.md#changelog`.  
- **Emergency Override (`@emergency_override`)**: If a unified rule causes critical breakage, include `@emergency_override:<rule-id>:<expires YYYY-MM-DD>` in a PR description. Cursor must treat the flagged rule as paused until the expiration (max 7 days) or manual removal. All overrides require approval from a Rules Champion and must be logged in `docs/architecture/cursor_rules_upgrade.md`.

## NAMESPACE CONSOLIDATION
- All sections in this document form the **"VeroForge Unified Rules"** namespace.
- Existing files under `.cursor/rules_legacy/*` form the **"Legacy Ruleset."**
- When instructions conflict, apply "VeroForge Unified Rules" and treat the "Legacy Ruleset" as supplemental context only.

## PURPOSE
These rules define how Cursor should behave in this workspace for:
- PR evaluation and REWARD_SCORE integration (CI as source-of-truth).
- Role-based guidance (modular prompts) for review, testing, coaching, distillation.
- Pattern application (human-reviewed, version-controlled).
- Safety, security, and routing.
- Clear human-in-the-loop for pattern extraction and automation.

Cursor MUST follow these rules unless the user explicitly overrides them.

---

## GLOBAL PRINCIPLES (applies to all modes)
- Prefer correctness & safety over automation.
- CI is the authoritative source for computed artifacts (REWARD_SCORE, coverage, static-analysis outputs).
- Never hallucinate file paths, PR numbers, or metrics. If uncertain, state you cannot find them and list closest matches.
- Always cite real file paths when referencing code (e.g., `src/auth/token_manager.py`).
- Prefer human-in-the-loop for knowledge updates (pattern creation, distillation) until patterns reach stable quality.
- Reference repository-specific guardrails from `AI_CONSISTENCY_PROTOCOL.md`, `DEVELOPMENT_BEST_PRACTICES.md`, and security policies captured in `.cursor/rules/03-security.mdc`.

---

## FILES / FOLDERS THIS RULES FILE RELIES ON
- `.cursor/prompts/` (role prompts; modular)
- `.cursor/patterns/` (golden patterns, validated)
- `.cursor/golden_patterns.md` (index + metadata)
- `.cursor/anti_patterns.md` (logged anti-patterns)
- `.cursor/BUG_LOG.md` (manual bug log)
- `.cursor/reward_rubric.yaml` (score weights & conditions)
- `.cursor/DEPRECATED_RULES.md` (migration tracker)
- `.cursor/scripts/` (`compute_reward_score.py`, `extract_patterns.py`, `suggest_patterns.py`, `reindex_embeddings.py`)
- `.cursor/ci/reward_score_comment_template.md`
- CI outputs (PR comment or artifact with REWARD_SCORE and breakdown JSON)

---

## ROUTING & MODE SELECTION (TRIAGER)
Cursor should load multiple modes additively depending on context:
1. Inspect file paths / PR description / tags.
2. Always include:
   - general patterns (`.cursor/patterns/*`)
   - security rules (`.cursor/prompts/security_review.md`)
   - testing rules (`.cursor/prompts/tester.md`) if code changed
3. Add specialized modes:
   - Backend: `backend/`, `src/api/`, `src/services/`, `*.ts`, `*.py`, `*.go` → `backend_reviewer.md`
   - Frontend: `frontend/`, `src/components/`, `*.tsx`, `*.jsx` → `frontend_reviewer.md`
   - Infra: `infra/`, `deploy/`, `k8s/`, `*.tf`, `.github/workflows/` → `infra_reviewer.md`
   - Data: `pipelines/`, `*.sql`, `airflow/`, analytics folders → `distill_data.md`
4. If multiple areas match, load all relevant prompts (routing is additive, not exclusive).
5. If no path matches, default to `@lead` prompt (`.cursor/prompts/lead_review.md`).

---

## MODULAR PROMPTS (HOW TO USE)
Cursor delegates behaviour to prompt files inside `.cursor/prompts/`. `00-master.mdc` orchestrates and loads prompts; prompts are authoritative for each role and must define:
- Required output format (machine-parseable first, human-friendly second).
- Fail-safe lines like: `If data missing, say "MISSING: <what>"`.
- Explicit citation requirements.

Required prompt files:
- `.cursor/prompts/lead_review.md`
- `.cursor/prompts/tester.md`
- `.cursor/prompts/coach.md`
- `.cursor/prompts/backend_reviewer.md`
- `.cursor/prompts/frontend_reviewer.md`
- `.cursor/prompts/infra_reviewer.md`
- `.cursor/prompts/security_review.md`

---

## @LEAD — PR REVIEW MODE (CI-ASSISTED)
**Trigger:** `cursor chat "review PR #<n>"` or CI comment.

**Workflow:**
1. Read CI-supplied REWARD_SCORE comment/artifact if present.
2. If no CI score, ask for CI outputs or compute a *draft* score using local analysis and label it `DRAFT`.
3. Required output (machine-friendly + human readable):

```
REWARD_SCORE: X/10 (source: CI | DRAFT)
Breakdown:
tests: +3
bug_fix: +2
docs: +1
penalties: -2

Assessment:
<2–4 sentences>

Actionable Feedback:
- ...
- ...

Decision:
APPROVE / REQUEST_CHANGES / BLOCK
```

**Rules:**
- If CI score < -3 and CI indicates failing tests/security issues → BLOCK and request changes.
- If REWARD_SCORE is borderline (-3..3) → require explicit `@lead` human review tag for merge.
- Always document references to CI artifacts or attach `reward_score_comment_template.md`.

---

## @TESTER — TEST GENERATION MODE
**Trigger:** Code changes in non-test files or explicit request.

**Deliverables per change set:**
- 3–6 unit tests covering happy path, edge cases, and error cases.
- Mocks/fixtures when external services involved.
- Coverage delta report (approximate) and files to add.
- Test suggestions must point to exact file paths & test file template (e.g., `backend/tests/test_auth_token.ts`).

---

## @COACH — PATTERN EXTRACTION (HUMAN-IN-THE-LOOP)
**Trigger:** High-score PR (CI REWARD_SCORE ≥ 6) or manual invocation.

Template:
```
Pattern: [Short name]
WHEN: [When to apply]
DO: [Implementation guidance]
WHY: [Principle]
EXAMPLE: path/to/file.ts#Lxx
METADATA: domain=[backend|frontend|infra|data], complexity=[simple|medium|complex], source_pr=#123
```

**Human step:** A senior engineer reviews candidate pattern before it's committed to `.cursor/patterns/`.

**Automation note:** CI may run `scripts/extract_patterns.py` to suggest patterns, but commits must be human-approved.

---

## DISTILLATION AGENTS (IN-PROMPT)
Cursor uses distilled knowledge from:
- `.cursor/patterns/` (primary)
- `.cursor/golden_patterns.md` (index)
- `.cursor/anti_patterns.md` (failures)
- `.cursor/BUG_LOG.md`

Distillation is prompt-driven (no model fine-tuning). Additions to these files immediately change agent outputs.

---

## PATTERN MANAGEMENT RULES
- Patterns are authoritative only after a human reviewer merges the pattern file via PR.
- Pattern file naming: `NNN_domain_short-name.md` (e.g., `001_backend_circuit_breaker.md`).
- Each pattern must include metadata (`created_at`, `author`, `source_pr`, `domain`, `complexity`).
- Maintain `.cursor/golden_patterns.md` as the canonical index.
- Anti-patterns for low-scoring PRs go into `.cursor/anti_patterns.md` plus `.cursor/BUG_LOG.md`.

---

## ANTI-PATTERN & BUG LOGGING
- Low-score PRs (CI REWARD_SCORE ≤ 0) produce anti-pattern suggestions.
- CI or reviewers append entries to `.cursor/anti_patterns.md` and `.cursor/BUG_LOG.md`.
- Every entry includes detection context, remediation guidance, and follow-up owner.

---

## SECURITY RULES (NON-NEGOTIABLE)
Cursor must refuse to produce code that:
- Exposes PII or secrets.
- Stores credentials in source code.
- Demonstrates insecure cryptography or SQL concatenation.
- Suggests disabling authentication or auditing.

For requests needing bypasses, respond with a refusal and outline safe alternatives. Cross-reference `.cursor/rules/03-security.mdc` for domain-specific requirements; unified rules override on conflicts.

---

## CONTEXT RETRIEVAL & FALLBACKS
When the user asks for internal knowledge:
1. Attempt semantic search across source code, `.cursor/patterns/`, `.cursor/prompts/`.
2. If semantic search omits `.cursor/patterns/*`, explicitly load relevant pattern files (fallback).
3. If a referenced file/artifact is not found, return `MISSING: <file>` and provide nearest matches.

---

## CI INTEGRATION (SOURCE OF TRUTH)
- CI steps must compute and publish:
  - `REWARD_SCORE` (with breakdown JSON or PR comment).
  - Test coverage summary (JSON).
  - Static analysis results (JSON).
- Cursor reads PR comments or artifacts with the key `SWARM_SCORE_JSON` or the standard reward template.
- Required workflows live in `.github/workflows/` and may call scripts in `.cursor/scripts/`.
- Any manual computation must be labeled `DRAFT`.

### Workflow Trigger Requirements
- **MANDATORY:** All workflows must have `on:` section with appropriate triggers.
- **MANDATORY:** PR workflows must include: `types: [opened, synchronize, reopened]`.
- **MANDATORY:** `workflow_run` triggers must match exact workflow names (case-sensitive).
- **MANDATORY:** Workflow names in `workflow_run` must exist in `.github/workflows/`.
- **MANDATORY:** Artifact names must be consistent across workflows (standard names: `reward`, `frontend-coverage`, `backend-coverage`).
- **MANDATORY:** Cascading workflows must verify parent workflow completed successfully.
- **MANDATORY:** Conditional logic (score thresholds) must be implemented for pattern extraction and anti-pattern detection.

---

## METRICS & OBSERVABILITY
Cursor expects:
- REWARD_SCORE distribution dashboards.
- Agent human-edit rate metrics.
- Pattern adoption counts.
- Anti-pattern recurrence reports.

If data is missing, surface `MISSING: <metric>` in outputs.

---

## HUMAN OVERRIDES & ESCALATION
- `@lead` humans may override CI-computed REWARD_SCORE (CID stored in DB/PR comment).
- Changes to `.cursor/patterns/` must be through PR reviewed by a Swarm Champion.
- Security/infra code requires explicit human approval before merge (document in PR).
- Any override or emergency suspension must be logged in `docs/architecture/cursor_rules_upgrade.md`.

---

## VERSIONING, ROLLBACK & REQUIRED APPROVALS
- Patterns and rules live in git; rollback = `git revert`.
- Automated scripts modifying `.cursor/*` must create a PR for human review.
- PRs touching `00-master.mdc` or any file in `.cursor/rules/*` require approval from the designated Rules Champion list in `docs/architecture/cursor_rules_upgrade.md`.

---

## SAFEGUARDS & VALIDATION
- CI validates required files exist (prompts, patterns, scripts). Failing checks block merges.
- Conflict-detection automation scans legacy files for overlapping directives and opens issues/PR comments.
- Testing harness (documented in `docs/architecture/cursor_rules_upgrade.md`) must be run after major rule changes to verify routing and precedence behavior.
- `DEPRECATED_RULES.md` tracks reconciliation progress for each legacy document.

---

## LEGACY RULE COMPATIBILITY
Cursor must continue to load the existing `.cursor/rules_legacy/*` documents. However, if a legacy file conflicts with instructions in this `00-master.mdc`:
- Treat the legacy file as legacy guidance.
- Follow the newer rule defined here (VeroForge Unified Rules).
Document reconciled files in `.cursor/DEPRECATED_RULES.md` and update CI conflict flags.

---

## END OF RULES
